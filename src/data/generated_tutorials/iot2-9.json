{
  "title": "9",
  "slug": "iot2-9",
  "description": "Module from iot2.pdf: 9",
  "tags": [
    "iot2",
    "Elite"
  ],
  "content": "# 9\n\n\nPrototyping and Designing the \n\nSoftware for IoT Applications \n\nLearning Objectives \n\nLO 9.1 \nDevelop the codes, design and test the embedded devices for IoT and M2M using IDEs \nand development platforms \nLO 9.2 \nAnalyse and program the devices, gateways, Internet connectivity, web and cloud \napplications using the open-source implementations of Eclipse IoT stack \nLO 9.3 \nDescribe prototyping methods of the online components for IoT application APIs \n\nRecall From Previous Chapters \n\nSection 1.4 listed the following five entities for the technology behind IoT systems: \n\n1. Device platform consists of device hardware and software using a microcontroller (or SoC \n\nor custom chip), and software for the device APIs and web applications \n2. Connecting and networking (Connectivity protocols and circuits) enabling the internetwork \n\nof devices and physical objects, called \u2018things\u2019; enabling Internet connectivity to remote \nservers \n\n3. Server and web programming enabling web applications and web services \n4. Cloud platform enabling storage, computing,  prototyping and product development \n\nplatforms \n5. Online transactions processing, online analytics processing, data analytics, predictive \n\nanalytics and knowledge discovery enabling large number of  applications of an IoT system. \n\nPrototyping and Designing the Software for IoT Applications \n327 \n\nThe previous chapter defined embedding as a process of embedding software into a computing \nhardware to enable system functioning for the specific dedicated application(s). A device- \nplatform embeds software into computing and communication hardware, and it functions for \nspecific  application(s). The chapter covered the hardware and prototype development using \na device platform, such as, Arduino, Galileo, Edison, Raspberry Pi, BeagleBone,  mBed. The \nchapter described basics of designing the embedded devices. The descriptions included the \nfollowing: \n\n\u25cf Uses of embedded software functions, device APIs and middleware; the middleware enables \na device to perform the functions of the computing and communication. \n\n\u25cf Connectivity interfaces consist of processing units, device interfaces and APIs for \ncommunication. They perform the computing and communication functions. \n\n\u25cf Integrated Development Environment (IDE) enables the coding on a computer connected \nwith the embedding platform, downloading of the codes from the computer and development \nof error free codes using a number of edit test-run, and debug cycles (Section 8.2). \n\n9.1 \nINTRODUCTION \n\nFigures 1.3 to 1.5 showed that in order to develop the IoT software five levels are needed: \n(i) Gather + Consolidate, (ii) Connect, (iii) Collect + Assemble, (iv) Manage and Analyse \nand (v) Applications and Services. This chapter will explain the five levels and required \nsoftware in detail. \n\nThe present chapter focuses on methods of developing software, which are used at \nlevels of IoT devices, gateways, Internet connectivity and web and cloud applications. \n\nRecall the meaning of the key terms, such as app, application, framework, XML, API, \nscript, java script, object, client, server, URL, HTTP, HTML5, web service, WebSocket and \nbootloader, Application Programming Interface (API) Operating System (OS), Real-Time \nOS (RTOS), process, task, thread, IDE and library from Chapters 3 and 8. Some of these \nkey terms are re-explained along with new terms. The understanding of these terms will \nenable the reader ease in learning the development processes for software including the \nAPIs: \n\nComponent is an abstraction for a core set of frameworks, services or software functions \nthat can be reused after reconfiguring them for providing solutions. \n\nSoftware framework is an abstraction which provides reusable software environment and \nsoftware with generic functionalities. A framework helps a user to selectively change and \nadd new functionalities when reusing the functions that create new applications, services, \nproducts and solutions. For example, assume a framework which provides generic \nfunctionalities for graphics and drawing the objects. A drawing application developer \nselects and reuses the framework functions, selecting the drawing and visualising \nfunctions, like ellipse or circle and adding the required ellipse or circle parameters such as \nsize, position, colour, shading and fill patterns. An application runs and draws the object \n\n328 \nInternet of Things: Architecture and Design Principles \n\nas per the parameters and uses the generic functions provided in the drawing framework. \nThe analogy can be taken from a candle building framework which is used in the candle \nmaking industry. Putting the threads in appropriate holes and filling of molten wax makes \na bundle of candles. \n\nApplication framework is a framework that supports a fundamental structure and provides a \nskeleton which leads to development of applications, and provides reusable development \nenvironment with generic functionalities. The framework helps a user to selectively \nchange, add new functionalities and build the application. \n\nWeb-application framework is a framework which supports the fundamental structure and \nskeleton, which leads to the development of web-applications including, web APIs and \nresources. The framework provides reusable web-application development-environment \nwith generic functionalities. The framework helps user of framework selectively change \nand add new functionalities and build web application or web service and APIs. \n\nCommunity is a software development initiative or model, which uses collective efforts \nfor software development. A community forms on initiative of universities, organisations \nand institutions for an open source project. The community is an approved open-source \nindependent foundation for distribution, like OSGi. A foundation or community may also \nhold copyright and commit to follow distribution practices, contributor agreements and \nlicensing, for example, Apache foundation, for the Apache server. \n\nOSGi (Open Service Gateway Initiative) is a development framework for Java that is used \nfor deploying modular software programs, libraries and bundles. \n\nOSGi  bundle refers to a tightly coupled collection of classes, jars, and configuration files. A \nbundle is dynamically loadable. The external dependencies are explicitly declared, when \nexisting. \n\nSoftware stack is a set of frameworks and services that is minimum need for an intended \ncomplete solution. Examples are Eclipse IoT Stack for IoT and Berkeley Data Analytics \nStack (BDAS) for analytics solutions. A stack may be community supported. For example, \nOpen Services Gateway initiative (OSGi) supports Eclipse IoT Stack. Stack provides a set \nof software functions, frameworks, packages, modules or subsystems. The stack creates a \ncomplete platform to support the applications or services when installed and configured \non individual systems or added to the templates for automatic installation. \n\nSandbox server 1 is a server with data from the source code distributions and other collections \nof contents, data or sets of the codes, proprietary or public, and is protected from changes \nintentional or unintentional. The server functions as a working directory, test server or \ndevelopment server. A sandbox is also used for testing a developed application. Sandbox \nclient uses the server\u2019s minimal functionalities, same environment variables or access to \nan identical database of the server for the development of specific functionalities and \napplication(s). \n\n1 https://en.wikipedia.org/wiki/Sandbox_(software_development) \n\nPrototyping and Designing the Software for IoT Applications \n329 \n\nLinux distribution means a package or set of software functions and modules of Linux, \nbundled together for specific functions or for specific hardware, and distributed for wider \nusages and applications. \n\nBootloader is system software which loads or embeds into a microcontroller chip or \ncomputing platform to let the system start its functions. \n\nOS is system software. It manages the processes, memory, IOs, network subsystems and \ndevices. It enables prioritisation, multitasking, concurrent running of multiple threads \nand many system functions using given computing device hardware. An OS may be open \nsource, for example, Linux or its distribution. A Linux-based OS distribution is Debian \nSqueeze Arch Linux Fedora for Raspberry Pi or BeagleBone using an ARM processor. \n\nMultitasking or multithreading means execution of multiple tasks or threads, according to \nsome plan, such as active or unblocked tasks run according to a sequence or one after one \nin allotted time slices or according to the priorities assigned for each or run first called task \nfirst. The OS supervises the running of the tasks and threads. \n\nReal-time Operating System (RTOS) is also a system software and is an OS that enables \nrunning of real-time processes on computing and communication hardware. \n\nScript is a piece of code in text form, which runs using an Interpreter , which interprets them \nat the runtime. Examples of the scripting languages are JavaScript, JSON, Perl and PHP. \n\nC is a high-level programming language, used for coding the embedded platforms. The \ncodes compile and generate the executable codes for that platform or computer. C is a \nprocedure-oriented language. \n\nFunction (method) is a named entity with arguments in between the brackets () and has the \nstatements in C or other programming language. The arguments are specified within the \nbrackets or quotes. The arguments associate with the function, pass the initial values and \nreturn the results. For example, assume a function chocolates_Sold() for calculating the \nchocolates sold during the specific interval using a sales table.  Then three arguments are \nstart and end dates, annual sales table that will be passed in the function for the execution \nof the statements and fourth argument returns the value = total number of chocolates sold \nduring the interval after the calculations. \n\nData values are passed from a (calling) function to a called function and the results \nafter executing the statements can be sent (returned) for use by a function needing those \nresults. Each language has some element similar to C function. For example, a function is \ncalled a method in Java for the similar purpose. \n\nException is a signal or object which represents occurrence of an event, exceptional \ncondition or conditions on which another set of codes need to run. This set of codes may \nbe at a callback() or catch() function. Exception is thrown (sent to the system) on the \noccurrence. It is thrown when an exceptional condition arises during the execution of a \nfunction or a set of statements. \n\n330 \nInternet of Things: Architecture and Design Principles \n\nCatch is a method (function) which runs only once on the occurrence of an event. A thrown \nexception is said to be caught by the catch() , also called callback() method. The event \nobject resets or removes (points to null) at start of the catch() . \n\nC++ is a high-level object-oriented programming language, which includes classes, \nobjects as well as C codes. C++ codes also compile and generate executable codes. A \nmodified version of standard C/C++ used at the device platforms includes additional \nsoftware libraries, and that may subtract certain functions. Subtracting may be due to \nneed of limiting the usages of system memory in small memory platforms or due to no \nnecessity of them for specific problems or hardware. For example, Arduino platform C++ \ncompiler uses avr-gcc, which does not provide for handling of exceptional conditions \nand try-catch blocks which are used in standard C++. Examples of additional libraries are \nspecific programs for distinct actions, which provide for programs, such as sending data \nto a USB port for onward transmission onto the Internet, and for the usages of protocols, \nports, serial ports, USB ports, GPIO pins, timers, Ethernet and hardware units at a device \nplatform. The avr stands for AVR \u00ae microcontroller at the Arduino boards. The gcc stands \nfor GNU C/C++/Objective C compiler. The avr.gcc enables usage of codes, which run on \nthe AVR. \n\nCompiler is the software for debugging and listing errors, if any, and then converting the \ncodes into running executable codes on a specific computing platform and environment. \nLanguages, such as C, C++ need compilers to enable running the codes on a computing \nplatform and run-time environment. \n\nCompiled virtual-machine language refers to a language such as Java or C# that compiles \ncodes, which are platform and runtime environment independent. The codes need a \nVirtual Machine (VM) or a framework that enables running on a computing platform and \nrun-time environment. \n\nApplication Programming Interface (API) is a software which enables access to an app, \napplication or service. An API runs on a local or remote computing platform, which sends \nmessages from the client (user) end for the server (application) end, and receives server \nmessages for the client . \n\nMessage is a general term, which refers to communicating data, request, query or response \nduring communication from one end, say a client, server, script, function, method or API \nto the other end. \n\nGraphic User Interfaces (GUIs) refers to computer screen display tools, such as status bar, \ntask bar, buttons, check-boxes, menus and dialog boxes which enable easy interactions of \nAPIs between the user and app, application or service software. \n\nGraphical software means software with the GUIs. \n\nCross-platform software refers to software which can be developed on one system, such as a \ncomputer for another computing platform, such as Arduino. \n\nPrototyping and Designing the Software for IoT Applications \n331 \n\nLightweightsoftwarefunction denotes a function which requires limited additional resources, \nand is not dependent on the OS functions or functional resources of another source. \n\nClient is a piece of code which makes a request. Example is a CoAP client sending request \nto a CoAP server or an HTTP client sending request to an HTTP server. \n\nServer is one which generates the response to client request or which publishes messages \nor responses for the clients, which send the requests or subscriptions. \n\nBroker is an intermediate server which receives the published data, message, a client \nrequest or subscription from one end and which also functions as a server to send the \nmessages/responses for another client at the other end. For example, MQTT broker receives \ndata/messages published from the device platform using node.js MQTT client running \nan application and sends response to the other end Java MQTT client at the application \nrunning at a computing system or phone using subscription. \n\nJava is a widely used object-oriented, high-level programming language with large open \nsource libraries, communities and distributions. Java compiles into byte codes. The codes \ncan run anywhere on a computing platform, provided the platform includes a JVM (Java \nVirtual Machine). A JVM is a software to translate the byte codes into native machine \ncodes. Java is thus a compiled VM language. Machine means a computing platform \nconsisting of hardware, OS and Software. \n\nC# is an object-oriented high-level programming language and a compiled VM language \nthat compiles CIL (common runtime language) codes, which are called the managed codes. \nThe managed codes are CPU neutral and platform independent, and therefore can run \nanywhere on a computing platform provided the platform has the runtime environment \nand framework, such as dot Net. \n\nPerl , a scripting language, the usages of which are for handling and parsing the XML, and \nparsing of the strings of character data and messages of the client for the server and the \nmessages of server for the client (Section 3.3). Perl also has vast libraries. Perl enables easy \ncoding of the scripts, even for big websites. A set of script codes execution is slower than \nC++ and need greater runtime memory for parsing. \n\nPython , a high-level language in which codes are interpreted at runtime, expresses code in \nfewer lines compared to Java or C++, and supports big libraries and open source codes on \na computing platform or computer. 2 A version is Cpython, which is a community, Python \nsoftware foundation manages. \n\nRaspberry Pi, BeagleBone or other platforms also run Python. There are many advantages \nof using Python. Examples are easy sending requests and receiving responses from the \nInternet services, regular expression coding for short expressions for easy handling and \nparsing of the strings of character data, such as weather data (Example 1.1), message \nstrings to or from a server or cloud, self-memory management and easy connecting and \nquerying of databases. The codes execute little slower than C++ and need greater memory. \n\n2 https://en.wikipedia.org/wiki/Python_(programming_language) \n\n332 \nInternet of Things: Architecture and Design Principles \n\nRuby is a programming language which is used for development of a web application and \nservice. \n\nEvent model enables the functions, methods, scripts or APIs run on eventing. The scripts \ncan run in multitasking mode on multiple events. Assume, if four events occur then for \neach event a script or function runs and four tasks, each executing multiple scripts which \nrun on eventing. \n\ncallback() i s a method (function) which runs on the event. For example, on receiving a \nmessage or the data or a request or a change in a parameter value behind a set-limit or on \noccurrence of certain action or exception. A callback() runs on the event and therefore, \nan eventListner() function need to run (explicitly or implicitly in background) for \nlistening the occurrence of that event and finding the need of running callback() . \n\nNode.js is a framework for creating the JavaScript codes for running on a cross platform \nenvironment, including browser, such as Chrome. The framework enables faster creation \nof the scalable network applications for distributed devices using a browser. The code \ndevelopment is fast when compared to creating that from JavaScript directly. Scalable \nmeans can be made big or small. \n\nNode.js programming is based on the event model for running of scripts in an application. \nThe scripts at the callback() functions run at the multiple distributed devices on the \nevents. Node.js framework thus enables development of real time web applications and \ngames using the browsers where input-output needs to be processed fast. \n\nProcessing language is a programming language for a development environment. Processing \nis open source. A computer programmer can download the environment from the website \nfor the processing language. 3 The language also enables creation of an elegant GUI-based \nprogramming interface. \n\nWiring , 4 an open source module consists of a set of hardware and software which is similar \nto Arduino and has programming environment for an Arduino like device platform. \n\nSketch in Arduino means an open source unit of code (a program unit), which uploads \non the device platform/board and runs. An example is blink sketch, which is the code for \nblinking at the board when run. Another example of sketch is for analog reading and serial \nprinting (or displaying on serially connected computer) at successive intervals or RFID \ntag ID reading or I2C device data reading. \n\nFirmware refers to software permanently residing at a circuit Read Only Memory (ROM) \nor flash.  Firmware provides specific functionalities of that circuit, such as bootloader, a \nstart-up program on power on and ROM BIOS (basic input-output system) functions. \n\nLua extension language/scripting language , is a dynamic type language for a number of \nhost platforms. Lua has features of co-routines (multiple tasks running at distributed \napplications, dynamic loading of the modules, usages of first class functions (supporting \n\n3 http://www.processing.org \n4 http://www.wiring.org.co \n\n\n![Image](/src/assets/generated_images/iot2_p359_i0.png)\nPrototyping and Designing the Software for IoT Applications \n333 \n\npassing functions as arguments to other functions, returning them as the values from other \nfunctions or assigning the values to the variables or values in data structure). 5 \n\nSection 9.2 describes the ways of developing software for the embedded device \nplatforms using the IDE. Section 9.3 describes the ways of developing gateway software \nfor communication between the devices and applications and services at a cloud or server \nusing  Eclipse IoT stack. Section 9.4 describes ways of developing the online component \nAPIs, web APIs and WebSocket APIs for message exchanges between embedded devices \nand applications and services at  the server or cloud. \n\n9.2 \nPROTOTYPING EMBEDDED DEVICE \nSOFTWARE \n\nThe previous chapter described prototyping and development \nboards\u2014Arduino, Intel Galileo, Edison, Raspberry Pi, \nBeagleBone and mBed. Prototype development of the \nprograms requires bootloader, OS and IDE. Software embeds \ninto a device platform. \n\nFirst level in IoT architectural concept is gathering (data \nfrom devices/sensors) + consolidating (enriching). Second level \nis connection to the Internet. An IDE enables development of \nsoftware for functions at first and second levels. IDE may also \nenable usages of the OS or RTOS functions at an embedded \ndevice. \n\nBootloader firmware stores at flash/ROM of a microcontroller in a device and enables \ncommunication with a computer having an IDE. The IDE, in general, consists of the \nAPIs, libraries, compilers, RTOS, simulator, editor, assembler, debugger, emulators, logic \nanalyser, code burner, and other software for integrated development of the system. \nAn IDE may be an open source. For example, Arduino has an open source IDE which is \ndownloadable from the Arduino website. \n\nIDE enables the development of codes on a computer, and later on downloading \n(pushing) of codes on to embedded device, such as Arduino or microcontroller board. The \ncode-burner places codes into flash memory or EEROM or EPROM. The specific application \ncodes are thus embedded into the device. \n\n9.2.1  Programming Embedded Device Arduino Platform \n\nusing IDE \n\nArduino board can be programmed using avr-gcc tools. 6 The \nArduino board has a pre-installed bootloader embedded into the \nfirmware. \n\n5 https://en.wikipedia.org/wiki/First-class_function \n6 http://www.nongnu.org/avr-libc \n\nDevelop the \ncodes, design \nand test the embedded \n\ndevices for IoT and \nM2M using the IDEs \n\nand development \n\nplatforms \n\nLO 9.1 \n\nIDE enables \ndevelopment of \nsoftware at first level \n\nand second level for \nembedding into device \n\nplatform \n\nArduino IDE open \nsource from http:// \n\nwww.arduino.cc \nprovides multitasking \nsimplicity and enables \n\nthe development \nof the codes, their \nsimulation and upload \n(embedding) on to the \n\ndevice \n\n334 \nInternet of Things: Architecture and Design Principles \n\nArduino programmer develops the codes using a graphical cross-platform IDE. Arduino \nprovides simplicity. IDE of Arduino board also has simplicity, is based on processing \nlanguage and makes the programming easy. The board connects to a computer which \nruns the IDE. The bootloader program hand overs the control and enables running of the \nloader, which loads the required OS functions and software into the system hardware and \nnetworking capabilities into the board. \n\nThe Arduino bootloader provisions for multitasking by the usage of interrupt (analogous \nto eventing) handing functions for each task. Multitasking is done by assigning multiple \nvalues of a number n for the tasks ( n > 0). When an instruction for interrupt; for example, \nINT n executes, then interrupt-handing function n is called for execution. Each task or \nthread can have the number n associated with it. Interrupt-handing function, similar to a \ncallback( n ) executes on event n or similar to catch function on exception n . \n\nThe IDE consists of a set of software modules, which provide the software and hardware \nenvironment for developing and prototyping the software for a specific device platform. \nFirst, a computer downloads an appropriate IDE version, as per the computer OS. A \ncomputer usually runs Windows or Mac OS X or Linux. \n\nThe bootloader enables the computer to push the developed codes into a board using \nthe Arduino IDE through a USB cable or a labelled serial port. Arduino bootloader need \nnot initiate the upload of OS , as done in a computer where bootloader loads the OS from the \nsecondary disk. \n\nThe Arduino IDE is available from the website of Arduino. 7 A programmer downloads \nthe required IDE version. IDE runs on the computer and enables the development of the \ncodes, their simulation and upload (embedding) on to the device platform. \n\nThe Arduino IDE includes a C/C++ library. The library is called Wiring for a project of \nthe same name with open source module at a website. 4 The Wiring library functions make \ncoding easy for the Arduino IO operations. \n\nDevelopment of the Codes \n\nArduino IDE functions as a file editor for the codes using the Processing environment and \nlibrary functions. The editor provides automatic indentation, highlights the syntax of the \ncodes and matches braces. The edited file compiles, checks and lists errors, if no errors, \nenables pushing of codes for embedding onto the board through serial or USB port. \n\nSimplicity of Arduino is clear from the fact that only two functions are necessary to \ndefine executable program functions for the board, namely, setup() and loop() . The \nfunction setup() runs at the start and is used for initialising settings, and function \nloop() has a program in endless loop using statement  \u2018while (true) { statements ;}\u2019 which \nruns till power off. \n\nA serial monitor at the IDE enables messages from the embedded software for the \nmicrocontroller into the computer screen where the IDE is setup. The messages are \nrequired during testing and debugging the downloaded software during test stages. \n\n7 http://www.arduino.cc \n\nPrototyping and Designing the Software for IoT Applications \n335 \n\nUsing GPIO Pins \n\nAssume that a programmer is well versed in C/C++ programming. Example 9.1 shows how \nto program GPIO pins and serial monitor at the IDE (for computer screen display) using \nArduino IDE C/C++. The example is for switching on only of north and south pathways TLs. \nNext example will describe full control of traffic lights for all four pathways sequentially \nand also use of an internal LED for testing the successful running of the program. \n\nExample 9.1 \n\nProblem \nProgramming for Arduino controlled traffic-control lights (TLs) at a road junction: \nAssume Arduino Uno board as an embedded device platform (Section 8.4.1) for the following project: \nthree TLs\u2014Red, Yellow and Green needs to be controlled on each of the four north, east, south and west \nclockwise pathways. \nLet twelve GPIO pins on Uno connect twelve number externally connected LEDs, R 0 , Y 0 , G 0 , R 1 , Y 1 , G 1 , R 2 , \nY 2 , G 2 , R 3 , Y 3 , and G 3 , (four sets of three R, G, Y LEDs each). The port LEDs represents the TLs during the \nprototype-development and testing-stage. \n\nHow can the port LEDs be On-Off programmed so that north and south pathways directed roads and traffic \nis switched on and east and west pathways traffic switched off? \n\nSolution \n\nFirst step is declaring the data types, constants, variables and functions used. Second and third steps are \ncoding for setup() and loop() . Example of program codes, which embeds onto Uno are as follows: \n\n/*Assume twelve digital IO ports assigned to external LEDs are port 2 to 12 and \nport 14. The ports are programmed according to TLs switching ON or OFF./ \n\n/* Pin 13 connects the board LED, and be used for indicating successful running \nof the developed codes during testing phases.*/ \n\nint internalLED = 13; \n\n/* Variables are written using a lower case first character */ \n\nint \nledR0, ledY0, ledG0, ledR1, ledY1, ledG1, ledR2, ledY2, ledG2, ledR3, \nledY3, ledG3; \n\nAssign the pins to the respectively connected LEDs */ \n\nledR0 = 2; ledY0 = 3; ledG4 = 4; ledR1 = 5; ledY1 = 6;ledG1 = 7; ledR2 = 8; \nledY2 = 9; ledG2 = 10; ledR3 = 11; ledY3 = 12; ledG3 = 14; \n\n/* Declare Functions for sequences of traffic lights ON-OFF as follows: */ \n\nvoid north_south_Green() { \n\ndigitalWrite (ledR0, LOW); digitalWrite (ledY0, LOW); digitalWrite (ledG0, \nHIGH); \n\ndigitalWrite (ledR2, LOW); digitalWrite (ledY2, LOW); digitalWrite (ledG2, \nHIGH); \n\n}; \n\n/* Function Switch RED ON for East and West pathways*/ \n\nvoid east_west_Red() { \n\n336 \nInternet of Things: Architecture and Design Principles \n\ndigitalWrite (ledR1, HIGH); digitalWrite (ledY1, LOW);digitalWrite (ledG1, \nLOW); \n\ndigitalWrite (ledR3, HIGH); digitalWrite (ledY3, LOW); digitalWrite (ledG3, \nLOW); \n\n}; \n\n/**********************************************************/ \n\nvoid setup ( ) { \n\n/* GPIO pins 2 to 12 and 14 are thus assigned port numbers corresponding to 12 \nexternal LEDs, R0, Y0, G0, R1, Y1, G1, R2, Y2, G2, R3, Y3, and G3.*/ \n\n/* Assign mode of each pin as output */ \n\npinmode (ledR0, OUTPUT); // Constants are written in Upper Cases \n\npinmode (ledY0, OUTPUT); \n\n. \n\npinmode (ledY3, OUTPUT); \n\npinmode (ledG3, OUTPUT); \n\n/* Let Pin 13 be used for indicating successful running of the developed codes \nduring testing phases. Initialise internal Port 13 Digital IO Pin LED for \ntest.*/ \n\npinmode (internalLED, OUTPUT); \n\n/* Initialise start of the Board and Sequences. */ \n\ndigitalWrite (internalLED, HIGH); \n\n/* Display the settings of Digital IO pins at serial display-monitor on the \ncomputer where IDE is setup. */ \n\n/*Let UART mode baud rate = 9600*/ \n\nSerial.begin (9600); \n\nSerial.println (\u201cArduino project.Program for controlling three traffic signals- \nRed, Yellow and Green at four pathways\u201d); \n\nSerial.println (\u201cArudino board LED glows when cycle starts for the sequences of \nlights turning high and turns off for brief interval in order to indicate the \nsuccessful completion of the cycle\u201d); \n\nSerial.println (\u201cTwelve 12 external LEDs, R0, Y0, G0, R1, Y1, G1, R2, Y2, G2, \nR3, Y3, and G3 corresponds to 12 traffic lights at north, east, south, west \nfour pathways\u201d) \n\n} \n\n/***********************************************************************/ \n\nStep: Loop function which endlessly runs \n\nvoid loop () { \n\n/* Assume no right turn from pathways or left turn from pathways permitted, just \nfor simplicity and for learning the basics. */ \n\n/*Switch Green ON for North and South pathways */ \n\n/*Switch RED ON for East and West pathways*/ \n\n// Run Functions \n\nPrototyping and Designing the Software for IoT Applications \n337 \n\nnorth_south_Green(); \n\neast_west_Red (); \n\n} \n\nExample 9.2 is for a complete program for switching on and off of north and south \npathways and east and west pathways, after intervals of 10 s each. The LEDs in ON states \nremain so for 30 s period. Function delay() provides the period of 30 s and also the \nintervals of 10 s between switching on of traffic along north and south pathways and \nswitching on of traffic along east and west pathways. Test LED switch off for 6s between \nthe successive repeat cycles. \n\nExample 9.2 \n\nProblem \nProgramming for Arduino controlled traffic-control lights (TLs) at a road junction with control of on intervals: \nAssume the same set up and LEDs with the same connection as described in Example 9.1.  Assume that setup \nremains the same as before. Therefore, the steps 1 and 2 of Example 9.1 are same in the present example \nas well. \nHow can the port LEDs be on-off programmed codes for Step 3: Function loop ( ). The new codes are for \nsignalling and lights control of all four pathways. Assume delays of 10 s each between successive states of \nLEDs and steady state for 30 s for a pair of pathways. \nWrite the Function test ( ) to find that the software is functioning as programmed on the board. Assume \nthat test function uses on-board LED at GPIO pin 13 during the period of running of codes. \n\nSolution \n\nProgram codes in Step 1 for pre-processing declarations, which embeds onto Uno, are same as in Example \n9.1. \n\n/*  Assume twelve digital IO ports assigned to external LEDs are port 2 to 12 \n\n. \n\nledY2 = 9; ledG2 = 10; ledR3 = 11; ledY3 = 12; ledG3 = 14; \n\n/* Declare Functions for sequences of traffic lights ON-OFF as follows: */ \n\nvoid north_south_Green() { \n\ndigitalWrite (ledR0, LOW); digitalWrite (ledY0, LOW); digitalWrite (ledG0, \nHIGH); \n\ndigitalWrite (ledR2, LOW); digitalWrite (ledY2, LOW); digitalWrite (ledG2, \nHIGH); \n\n}; \n\n/* Function Switch RED ON for East and West pathways*/ \n\nvoid east_west_Red() { \n\ndigitalWrite (ledR1, HIGH); digitalWrite (ledY1, LOW);digitalWrite (ledG1, \nLOW); \n\ndigitalWrite (ledR3, HIGH); digitalWrite (ledY3, LOW); digitalWrite (ledG3, \nLOW); \n\n}; \n\n338 \nInternet of Things: Architecture and Design Principles \n\n/* Function Switch Yellow ON for North and South  pathways forbrief interval \nbefore change of state */ \n\nvoid north_south_Yellow (){ \n\ndigitalWrite (ledR0, LOW); digitalWrite (ledY0 HIGH); digitalWrite (ledG0, \nLOW); \n\ndigitalWrite (ledR2, LOW); digitalWrite (ledY2, HIGH); digitalWrite (ledG2, \nLOW); \n\n} ; \n\n/* Function Switch Green ON for East and West pathways*/ \n\nvoid east_west_Green (){ \n\ndigitalWrite (ledR1, LOW); digitalWrite (ledY1, LOW);digitalWrite (ledG1, HIGH); \n\ndigitalWrite (ledR3, LOW); digitalWrite (ledY3, LOW);digitalWrite (ledG3, HIGH); \n\n} ; \n\n/* Function Switch RED ON for North and South pathways*/ \n\nvoid north_south_Red (){ \n\ndigitalWrite (ledR0, HIGH); digitalWrite (ledY0, LOW); digitalWrite (ledG0, \nLOW); \n\ndigitalWrite (ledR2, HIGH); digitalWrite (ledY2, LOW);digitalWrite (ledG2, \nLOW); \n\n}; \n\n/* Function Switch Yellow ON for East and West pathways */ \n\nvoid east_west_Yellow  () { \n\ndigitalWrite (ledR1, LOW); digitalWrite (ledY1, HIGH);digitalWrite (ledG1, \nLOW); \n\ndigitalWrite (ledR3, LOW); digitalWrite (ledY3, HIGH); digitalWrite (ledG3, \nLOW); \n\n}; \n\n/******************************************************************/ \n\nProgram codes in Step 2 for setup() same as in Example 9.1 as setting is unchanged. \n\nvoid setup ( ) { \n\n/* GPIO pins 2 to 12 and 14 are thus assigned port numbers corresponding  */ \n\n. \n\nSerial.println (\u201c Twelve 12 external LEDs, R0, Y0, G0, R1, Y1, G1, R2, Y2, G2, \nR3, Y3, and G3 corresponds to 12 traffic lights at north, east, south, west \nfour pathways\u201d) \n\n} \n\n/****************************************************************/ \n\nPrototyping and Designing the Software for IoT Applications \n339 \n\nModification in Step 3 function loop() are as follows: \n\nvoid loop () { \n\n/*Assume no right turn from pathways or left turn from pathways permitted, just \nfor simplicity and for learning the basics*/ \n\n/*Function Switch Green ON for North and South pathways */ \n\nnorth_south_Green(); \n\n/*Function Switch RED ON for East and West pathways*/ \n\neast_west_Red(); \n\n//Function delay (30000) \n\ndelay (30000); //Wait for 30 secomd \n\n/*Function Switch Yellow ON for North and South  pathways forbrief interval \nbefore change of state */ \n\nnorth_south_Yellow (); \n\n//Function delay (10000); \n\ndelay (10000); //Wait for 10 secomd \n\n/*Function Switch Green ON for East and West pathways*/ \n\neast_west_Green (); \n\n/*Function Switch RED ON for North and South pathways*/ \n\nnorth_south_Red (); \n\n//Function delay  (30000); \n\ndelay (30000); //Wait for 30 secomd \n\n/*Function Switch Yellow ON for East and West pathways */ \n\neast_west_Yellow  (); \n\n//Function delay  (10000); \n\ndelay (10000); //Wait for 10 secomd \n\n/*Testing to show completion of one cycle of traffic light \n\nLet internal board LED flash OFF for 6s before the sequences of lights repeat */ \n\n//Statements for  test; \n\ndigitalWrite (internalLED, LOW); delay (6000); // Wair 6 s \n\nSerial.println (\u201c One Sequence completed\u201d ); \n\ndigitalWrite (internalLED, HIGH); \n\n} \n\nEmulator and Debugging of Software \n\nEmulation means to do the actions similar to a real entity. Emulator \nsoftware emulates the running of an embedded device platform, \nknown as target board. Software emulates the embedded device \nplatform onto the computer. The developer observes the actions \non the computer. \n\nEmulating and \ndebugging of software \nensures reliable, tested \n\nand bug-free software \n\n340 \nInternet of Things: Architecture and Design Principles \n\nIn-circuit Emulation (ICE) means hardware debugging by emulation after connecting \nthe target board to the computer. The computer sets the break points in the embedded \nsoftware. The results at the end of each break point enable a programmer to find the bug \n(erroneous code or code-section). Computer can initiate single stepping through the codes. \nThe screen displays the registers in the microprocessor or microcontroller, the variables \nvalues at the end of each step or at the end of a specified section of codes. Computer \ndisplay also displays the contents of memory addresses at each break point. \n\nWhen embedded Linux is used on the board, then the developer can use a utility, called \ngdb (GNU debugger), which is open source at GNU website. 8 Connection of target board \nis through a serial or USB port of computer. Ethernet is also used for device platforms, \nwhich support networking. \n\nJTAG (Joint Test Action Group) standard enables testing of the target board onto the \ncomputer when JTAG software embeds into hardware, and JTAG connector connects the \nhardware to computer. \n\n9.2.2 \nReading from the Sensors and Devices \n\nUsing ADC Analog Input \n\nAssume a temperature sensor is used for measuring between 0 degree and 100 degree \nCelsius. A sensor sends analog output at an analog input of a 10 bit ADC (Section 7.2.1). \nAn ADC output converts to serial by a parallel input to serial-output (PISO) converter. \nThe serial output connects to the serial SPI input pin at Arduino Uno board. An RH% \nsensor can also be used in a similar manner where measured value is in RH% in place of \ndegree Celsius (Section 7.2.2). \n\nThe ADC output for a sensor at 100 degrees is decimal 1023 (=binary 1111111111) and \ndecimal 0 (=0000000000) for 0 degree. Example 9.3 explains the usage of analog read \nfunctions for the Arduino. \n\nExample 9.3 \n\nProblem \nProgramming of Arduino for usages of analog sensor devices at SPI port: \nA temperature sensor analog output is given to an SPI at Arduino through a 10-bit ADC and PISO. How will \nthe data be read from the SPI input every hour into an Arduino board from the sensor? \n\nHow will the one hour wait loop be programmed and how does the test performed by LED on-off states using \na blinking program blink at each 3 s interval? \n\nSolution \n\nStep 1 is declaring the data types, constants, variables and functions used. Second and third steps are \ncoding for setup() and loop(). Example of program codes, which embeds onto Uno are as follows: \n\n#include <SPI.h> /*Include the Serial IO functions between Arduino SPI port and \nserial input from ADC. */ \n\n8 http://www.gnu.org/software/gdb \n\nPrototyping and Designing the Software for IoT Applications \n341 \n\n#include <util.h> /*IO utility functions. Includes UART interface, which \nconnects to computer for display of messages on computer-screen. IDE software \nprovides the functions for display using serial interface output of board. */ \n\n/* Sensed parameter, say, temperature Sensor Input at A0 pin. Define initial \ninput  = 0. */ \n\n#define TempSensorADCinput 0 \n\n/*calibCoeff = output change in parameter per unit rise in temerature by 1 \ndegree Celsius.  For example, calibCoeff  = temperature change per unit change \nin converted digital value of Vinput from the Sensor.*/ \n\n/* Define calibCoeff = 0.097752. */ \n\n#define calibCoeff 0.097752 /*The calibCoeff is 100/1023 = 0.097752 when sensed \nparameter analog value is between 0 degree Celsius to 100 degree Celsius and \nobserved digital value is from 0 to 1023 from 10-bit ADC*/ \n\nfloat observedV, parameter; /*observedV = Vinput from Sensor. The parameter = \nsensed parameter value 0\u2026.1023*/ \n\n/*Let internal LED at digital IO Pin 13 be used for indicating successful \nmeasurement and  wait for next reading */. \n\nint internalLED = 13; /* initialise internal Port 13 Digital IO Pin LED for \ntest Function. */ \n\n/* Name the unit, whether degree Celsius or RH% */ \n\nchar [ ] unit; \n\nunit = \u201cdegree Celsius\u201d; /* Declare the unit of sensed parameter unit*/ \n\n/*****************************************************************/ \nStep 2 is as follows for setup() statements of the program for setting the board and parameters for \nmeasurement of sensed V. \n\nvoid setup () { \n\n/* Declare the unit of sensed parameter initial value and initial observed V*/ \n\nparameter = 0.0; // Declare the initial value of the parameter \n\nobservedV= 0.0; // Declare the observedV = 0 at minimum \n\nSerial.begin (9600); //Let UART mode baud rate = 9600. \n\nSerial.println (\u201cArduino Program for input for ADC input at the board\u201d); \n\nSerial.println (\u201cCheck that Arduino pin A0 connects ADC input from the sensor \n\u201d); \n\nSerial.println (\u201cCheck that Arduino 3.3 V pin connects ADC reference pin at the \nsensor\u201d); \n\npinMode (internalLED, OUTPUT); \n\n// Indicate start of the Board and Sequences \n\ndigitalWrite (internalLED, HIGH); \n\n// Display the results at serial display monitor on computer where IDE is setup \nSerial.println (\u201c Arudino board LED glowing starts when hourly cycle starts \nfor the sequences of LED lights turning high and turns off for successive 3s \nintervals in order to indicate that system is waiting for the next hourly \nreading\u201d); \n\n342 \nInternet of Things: Architecture and Design Principles \n\n} \n/*******************************************************************/ \nStep 3 is as follows for loop() statements of the program for measuring the ADC input and parameters for \nthe measurement of sensed V at successive interval. \n\nvoid loop () { \n// ADC uses analog reference voltage and it is internally set. \n\n//A reference voltage is 3.3V at the Uno. \n// The value is used to convert the acquired value into appropriate reading, \n// for example, temperature value in degree Celsius units or into RH% \n\n//10-bit ADC means analog voltage resolution is (Vref/ 1024) \n\nobservedV = analogRead (TempSensorADCinput); \n\n//parameter is found from the calibration coefficient \n\nparameter = calibCoeff*obesrvedV *1023/3.3; \n\nSerial.print (\u201cTemperature =\u201d); //Assume sensed parameter is temperature \n\nSerial.println (parameter, unit); \n\ntest ( ); \n\n} \n\n/*****************************************************************/ \nStep 4 includes a test() . The statements for test function are as follows: \n\nvoid test ( ){ //Start blinks every three second \n/* One Hour wait for next reading. Run the loop 600 times. Each wait for 3+ 3 \nsecond. 6 s \u00d7 600 = 1 hour and LED blinks at 3s ON-OFF intervals*/ \ndigitalWrite (internalLED, HIGH);} \n\nfor ( int i = 1, i<=600) , i++) { \n\ndelay (3000); \n\ndigitalWrite (internalLED, LOW); \n\ndelay (3000); // Wair 6 s \n\ndigitalWrite (internalLED, HIGH); \n\n} \n\nUsing the Libraries \n\nSections 7.5 described software serial libraries and their usages for data communication \nusing serial bus protocols, UART, I2C, USB and CAN. Section 8.3.6 described mBed device \nplatform libraries. The library functions can directly be used during coding. \n\nUsing the Timers \n\nTimer functions are required in a number of applications. A number of timer libraries \nare available. A set of timer functions library is available online. 9 MsTimer stands for \nmillisecond timers with two states. It holds a simple usage (Example 9.4). It has two \n\n9 http://www.arduino.cc/playground/Main/MsTimer2 \n\nPrototyping and Designing the Software for IoT Applications \n343 \n\nfunctions set() and start() . First one sets the timer for interrupt after a preset interval \nand second one to start running the timer. \n\nExample 9.4 \n\nProblem \nProgramming of Arduino for uses of timer library functions: \n\nHow will you use the Mstimer2 library to call a function action() after successive intervals which are preset \nat 3 s? \n\nSolution \n\nFollowing are the statements which calls action() every 3s using Mstimer2. \nStep 1: Statements for preprocessor commands, declarations of data types and functions and inclusion of \nrequired library files. \n\n#include <MsTimer2.h> \n\nvoid action ( ) { \n\n/* Write statements for actions on preset time over, for example change of \noutput at an IO pin*/ \n\n} \n\n/*****************************************************************/ \nStep 2: Statements are for pin configuring and initial set up statements as in Examples 9.1 to 9.3. A \nstatement specifies a preset value for the interval after which timer MsTimer2 will interrupt and call interrupt \nhanding function. Let function be specified and named action() . \n\nvoid setup ( ) { \n\n/* Write pins and initial setup statements. */ \n\n/* Set the millisecond timer to execute the function action ( ) after 3000 ms*/ \n\nMsTimer2: : set (3000, action); \n\n/* Start the millisecond timer*/ \n\nMsTimer2: : start ();} \n\n/******************************************************************/ \nStep 3: Statements are for codes for actions during 3s and which are repeatedly done, if stop condition not \ndefined inside the loop. \n\nloop ( ){ \n\n} \n\nUsing Software Serial Library \n\nA serial interface library has functions to read and write as per serial protocols. A protocol- \nbased communication first transmits the header bits. These may include the address of the \ndevice or registers (control, data, status or other registers). The data bits transmit after \nheader bits and control bits, if any. End-bits transmit in the end. Each serial protocol has \nspecific ways of formatting and sequencing during communication. \n\n344 \nInternet of Things: Architecture and Design Principles \n\nUART protocol based communication uses two signals, denoted by Tx or TxD (for serial \ntransmission of header, data and other bits) and Rx or RxD (for serial reception). Assume \nthat baud rate is 2400. Then, 240 times a new set of 8-bits data transmits in one second. \n10 bits transmit for each set for data, character, command or address. A byte represents \na character in a string, a sensed data and command for receiving device or address of \ndestined or receiving device. \n\nArduino board has pins 0 (Rx) and 1 (Tx) for UART serial communication. A computer \nconnects to the board using these pins. Software serial library has functions, which read \nand write serial data using Arduino\u2019s board. The data input-outputs can be at two pins \nof digital IO pins, other than 0 and 1, viz. pin 2 and pin 3 as the Rx and Tx, respectively. \n\nUART functions in software serial library set the pins modes as Tx and Rx. The \ncommunication initiates RFID Rx and Tx pins at the RFID IC, whenever RFID pins \nconnect to digital IO Tx and Rx pins, respectively. The IC TX becomes low from high when \ncommunication initiates from Arduino. RFID IC detects that and first sends a header, \nwhich represent a preset address of the device. \n\nThe Arduino serial interface reads the header before accepting the tag ID. ID is of 10 \ncharacters and the IC sends an end-character from the RFID at the end. End character \nASCII code is 13. \n\nSoftware serial library enables data communications using simple uses of serial read \nand write functions. Example 9.5 explains the serial read of an RFID tag using UART with \nthe help of the library functions. \n\nExample 9.5 \n\nProblem \nProgramming of Arduino for usages of RFID ID serial-data reading using UART port: \n\nAn RFID Integrated circuit (IC) sends serial data to an Arduino board using UART protocol Tx and Rx inputs \nat the RFID tag pins. How will serial data be read at pins 2 and 3 as Rx and Tx, respectively using Arduino \nboard? \n\nSolution \n\nFollowing is a program for reading serial data for the sensed value and stored 16-bit coefficients at IC. \n\nStep 1: Preprocessor commands, declarations of data types, functions and constants \n\n/* UART communication has 1 start bit. The first serial bit becomes LOW from \nHIGH for a period equal to baud interval. Then, 8 serial bits transmit in 8 \nsuccessive baud intervals. A stop bit then transmits for 1 baud interval. Total \n10-bits communicate for each serial write or read.*/ \n\n#include <UARTSerial.h> /*Serial IO functions for Arduino UART Serial Interface*/ \n\n#include <util.h> /*IO utility functions*/ \n\n/* Assume that IC uses address 0x08 for device header which includes address. \nLet the IC send 12 bytes, one for the header (address), ten bytes for the sensed \ndata or RFID tag or ID and one byte for the end character. (Data sheet of the \n\nPrototyping and Designing the Software for IoT Applications \n345 \n\ndevice specifies the actual address and format of header bits and tag or ID \nbits.)*/ \n\n#define UARTDEVICE_HEADER 0x08 \n\nint nID 10 /* number of characters in the string for the ID or number of bytes \nof sensed data from the device*/ \n\nchar [ ] ID_characters \u201c\u201d //A String Variable for ID_characters \n\nint header //Variable for the header received from the device \n\nint end // Variable for end character received \n\n/*Declare internalLED digital IO pin number which shows status of the running \nof the Board*/ \n\nint internalLED = 13 \n\n/*Declare Arduino IO pin numbers which the IC uses to transmit or receive \nserially from the board*/ \n\nint SerialRxPin 3 \n\nint SerialTxPin 4 \n\nclass SerialRxRequest { \n\nprotected: bool loop ( ); \n\nprivate: bool serialRx_request; \n\n} \n\nSerialRxRequest : : SerialRxRequest (bool serialRx_request) { \n\n/* Set the serialRx_request. Assign true to the request to serial reception of \nsensed data or RFID tag*/ \n\nthis -> serialRx_request = true; } \n\n/*****************************************************************/ \nStep 2: Setup statements to declare the modes of pins and initial states. \n\nvoid setup ( ) { \n\n/* Read data from UART DEVICE. An IC used as RFID tag or IC based sensor may be \nusing UART communication. */ \n\npinmode (SerialRxPin, INPUT); \n\npinmode (SerialTxPin, OUTPUT); \n\npinMode (internalLED, OUTPUT); \n\ndigitalWrite (internalLED, HIGH); \n\ndigitalWrite (SerialTxPin, LOW);//enable Serial reception \n\n} \n\n/******************************************************************/ \nStep 3: Continuously running loop till stop condition encounters. \n\nbool SerialRxRequest : : loop () { \n\n/*Serial Reception of characters as long as SerialTxPin = = LOW or SerialRx_ \nrequest = = true*/ \n\nif (SerialTxPin = = HIGH || serialRx_request = = false) ( \n\nSerialRx.stop ( ); serialTxPin = HIGH; } \n\n346 \nInternet of Things: Architecture and Design Principles \n\nIf (SerialTxPin = = LOW || SerialRx_request = = true) { \n\nSerialRx.begin (4800); /*Assume it communicates at baud rate = 4800. */ \n\nID_characters [0] = SerialRx.read (); // Reader Header character \n\n/*Check header character = 0x08, if match then read sensed data ten bytes and \nend character*/ \n\nIf (ID_characters [0] = = UARTDEVICE_HEADER) { \n\nfor (int i= 1; i< nID +2); i++) { \n\nID_characters [i] = SerialRx.read (); \n\nSerialTxPin = HIGH} \n\n// Statements for Serial Print of the result at Serial Monitor \n\n. \n\n/* Statements for communicating ID Characters or sensed characters on to \nInternet or Ethernet or USB*/ \n\n// Call test () for functioning of the serial IOs \n\ntest ( ); \n\nSerialTxPin = HIGH; //stop further read, loop terminate \n\nreturn false;) \n\n} \n\nUsing I2C Serial Protocol \n\nI2C protocol is communication protocol for a serial-bus that communicates in synchronous \nmode. A device transfers data as a master or slave. Master means the device can address \nand communicate with a number of slaves. Master sends clock pulses to the slave devices \nfor synchronisation. Maximum connected devices can be up to 127. \n\nAt one instance, one device functions as a master and another as slave, and functioning \ndepends on the internal circuit for I2C functions at the device. \n\nAssume that a sensor has built-in ADC as well as I2C interface, and communicates \nthe bytes over I2C SDA and SCL pins. Example 9.6 explains the usages of software serial \nlibrary for communication of bytes on I2C bus using Arduino. For details, refer to author\u2019 \nbook on embedded systems. 10 \n\nExample 9.6 \n\nProblem \nProgramming of Arduino for usages of synchronous serial-data read using I2C bus: \n\nHow will the data and coefficients be read from IC based sensor at Arduino serial port? Use the software \nserial library functions at IDE for reading I2C bus data. \n\nSolution \n\n10 Raj Kamal, \u2018Embedded Systems\u2014Architecture, Programming and Design, 3 rd edition, McGraw-Hill Education, New \nDelhi, pp. 169\u2013170, 2014. \n\nPrototyping and Designing the Software for IoT Applications \n347 \n\nThe serial pin A4 is for SDA bits and A5 for SCL bits. First connect the sensor IC with A4 and A5. Functions \nat software serial library enable uses of read and write for serial data. \n\nAssume Arduino functions as master device and an IC based sensor as a slave device. Assume that the sensor \nIC has addresses for control and data registers. The registers save at EEPROM memory in the IC. A measured \n16-bit value saves at two memory addresses, which save the data registers. A programming of control \nregister enables the working of the IC in several modes. The IC uses the data registers and communicates two \nbytes.  One is for higher and the other for lower bytes. Memory also saves and communicates the calibration \ncoefficients for communication as I2C serial data from a set of addresses. Assume device calibration data \nhas 22 addresses in memory for eleven values of 16-bit calibration coefficients. Following is the program for \nreading serial data for sensed value and stored 16-bit coefficients at the device. \nStep 1: Program codes for pre-processing declarations, data types and functions \n\n#include <Serial.h> /* Include functions between Arduino and Serial Monitor l*/ \n\n#include <Wire.h> /* include Wiring functions*/ \n\n#include <util.h> /*IO utility functions and include functions between Arduino \nand input-output devices*/ \n\n/*I2C protocol envelopes the data with header bits. First seven bits are for the \naddress of destination device. Define the I2C serial device address for use for \nthe sensor IC communication.  Assume that sensor uses address 0x08 for device \naddress and Device Data 1 Address 0x16 and data 2 address 0x17 (Data sheet of \na device specifies the actual addresses).*/ \n\n#define I2CDEVICE_ADDRESS 0x08 \n\n/*Assume control command is at address 0x02*/ \n\n#define char I2DEVICE_CONTROLDATA 0x02 \n\n/*Assume Data 1 address is at 0x06 and 2 at 0x0A. */ \n\n#define I2DEVICE_DATA1_ADDRESS 0x06 \n\n#define I2DEVICE_DATA2_ADDRESS 0x0A \n\n/*Declare two integers 16-bit variables, observedValue1 and observedValue2 */ \n\nint observedValue1, observedValue2 \n\n/*Declare two float (four bytes each) variables , value one for value1 after \nusing calibration coefficients and another for value2 after using calibration \ncoefficients */ \n\nfloat observedCValue1, observedCValue2 \n\n/*Declare unit of sensed parameter value, for example, degree Celsius*/ \n\n#define char [ ] unit \u201c\u2026\u2026\u2026..\u201d \n\n/*Declare internalLED digital IO pin number which shows status of the running \nArduino*/ \n\nint internalLED = 13; \n\n/*Assume that IC based sensor uses addresses from 0x18 to 0x2C, two addresses \nper 16-bit integer coefficient. (Data sheet of the device specifies the actual \naddress where calibration coefficients can store).*/ \n\n#define CALIBCOEFF_ADDRESS [ ] 0x18, 0x1A, 0x1C, 0x1E, 0x20, 0x22, 0x24, 0x26, \n0x28, 0x2A, 0x2C \n\n/*Declare array for integer values of calibration coefficients stored at the \n\n348 \nInternet of Things: Architecture and Design Principles \n\nIC memory*/ \n\nint calibCoeff [11] \n\nvoid I2CDeviceCalibration ( ){ //read calibration coefficients \n\nint j=0; \n\n/* I2CSerialReadInt is a function to read two bytes, higher and lower bytes. \nThe function returns a 16-bit integer value*/ \n\nfor (int j= CALIBCOEFF_ADDRESS [0], j <= CALIBCOEFF_ADDRESS [10], j = j +2) { \ncalibCoeff [j] = I2CSerialReadInt (CALIBCOEFF_ADDRESS [j]); \n\n} \n\nfloat DeviceSensedResult (observedValue ) { \n\n//Write statements for using calibration coefficients \n\n. \n\nreturn observedCValue; . \n\n} \n\ntest ( ) { \n\n//Write statements for testing the result . \n\n. \n\nreturn observedCValue; . \n\n/*************************************************************************/ \nStep 2: Program codes for setup() \n\nvoid setup ( ) { \n\nint observedValue0, observedCValue0, \n\nSerial.begin (9600); //Let UART mode baud rate = 9600 for serial monitor \n\nSerial.println (\u201c Arduino Program for input for sensor device using I2C protocol\u201d \n\nSerial.println (\u201c Check that Arduino pin SDA bits at pin A4 and serial clock \nSCL pin A5. \u201d); \n\npinMode (internalLED, OUTPUT); \n\ndigitalWrite (internalLED, HIGH); \n\n//Set I2C serial standard clock rate 100 kHz. \n\n// Write data at I2DEVICE \n\nWire.begin (); \n\n/* Get the eleven calibration Coefficients from the IC*/ \n\nI2CDeviceCalibration ( ); //Read integers for 11 calibration coefficients \n\n/* Declare initial offset, for example, Sensor value when temperature is 0 \ndegree Celsius or pressure is atmospheric pressure or photo-current when dark. \n*/ \n\nobservedValue0 = 0; // Declare the initial value of the parameter \n\n/* Calculate sensed Offset value result using calibCoeffs. */ \n\nobservedCValue0 = DeviceSensedResult (observedValue0); \n\nPrototyping and Designing the Software for IoT Applications \n349 \n\n} \n\n/*************************************************************************/ \nStep 3: Function loop() for the sensor readings and get the temperature values from read value using \ncalibration coefficient \n\nvoid loop () { \n\n//Read Integer at data 1 address \n\n//Read Integrate at data 2 address \n\nobservedValue1 = I2CSerialReadInt (I2DEVICE_DATA1_ADDRESS); \n\nobservedValue2 = I2CSerialReadInt (I2DEVICE_DATA2_ADDRESS); \n\n//find the result for sensed data \n\nobservedCValue1 = DeviceSensedResult (observedValue1); \n\nobservedCValue2 = DeviceSensedResult (observedValue1); \n\n/* Statements for Serial Print of the result at Serial Monitor. */ \n\n. \n\n. \n\n/* Write Statements for delay as per intervals between successive data 1 and \ndata 2 readings*/ \n\n. \n\n. \n\n/* Test function Statements for the test of status of running the program */ \n\ntest ( ); \n\n} \n\nUsing Cloud  Library at  Xively \n\nPaho, earlier known as Cosm, is now called Xively. Xively cloud platform is an application \ndevelopment platform. The cloud platform has library functions, which enable \nprogramming for web services, applications and APIs. The applications and APIs may be \nwritten in C/C++, Java, Python, dot Net, JavaScript, Perl, PHP or Ruby. \n\nUsing an OS \n\nOS is a system software for managing the processes, memory, IOs, network subsystems \nand devices management. The OS consists of system functions for priorities, multitasking \nor running a number of threads, and many system functions using given computing \ndevice hardware. \n\nLinux distribution libraries are for using Linux OS as a package or set of functions and \nmodules bundled together for specific functions or for specific hardware and distributed \nfor wider usages and applications. For example, in Arduino, mBed, microcontroller \ncircuits and embedded device platforms. \n\n350 \nInternet of Things: Architecture and Design Principles \n\nArduino Yun board has loaded Linux-distribution for Arduino into it. Computer used \nfor Arduino IDE downloads the Arduino Linux distribution for running at the Arduino, \nand then use it as the OS for developing Arduino application programs. Around 256 kB of \nRAM is required for this purpose. \n\nA code developer can use FreeRTOS or DuinOS for Arduino versions due to their \nsmaller memory needs. \n\nMultitasking \n\nA multitasking environment consists of multiple processes, tasks or threads. A process, \ntask or thread consists of a set of instructions that runs under OS control (supervision). \nAn OS has multitasking (multithreading) functions and many other system functions. \n\nUsing Threads \n\nConsider four delay instructions in the program given in Example 9.2. During the \nperiod for delay, the system is just waiting for a preset period to elapse. Consider a  set \nof instructions before each delay as one thread, and other sets of instructions and other \nthreads. When the OS is multitasking, then the delay period is utilised in running other in \nsequence or next to present one priority thread(s). The delay function is a system function \nand is called sleep() or OS_Delay() function of the OS. The sleep function makes a \nsystem call to OS to block that thread from running for the preset delay period. The sleep \nfunction argument specifies that period. \n\nThe OS threads can run in sequences when each thread has normal priority. OS can \nalso be made to run such threads for a specified time slice in each cycle of thread run \nsequences. \n\nUsing Real-time Thread Scheduling Library \n\nAn RTOS consists of threads, each thread is assigned with a specific priority level, and \nwhen a higher priority thread activates, then the system pre-empts the lower priority \nthread . \n\nA set of built-in functions for real-time scheduling (switching) enable the threads \nscheduling. A real-time thread-scheduling library is provided in system software.  An \nexample of the scheduling library is Atomthreads library which is downloadable online. 11 \n\nUsing GNU C Library Version \n\nA version of GNU C library enables Linux OS platforms at the microcontroller ( m C) in \nan embedded device. An example is uClib, which is downloadable from the university \nwebsite. 12 \n\nExample 9.7 shows the usage of OS multithreading functions with each thread assigned \nnormal priority. \n\n11 http://www.atomthreads.com \n12 http://www.uclibc.com \n\nPrototyping and Designing the Software for IoT Applications \n351 \n\nExample 9.7 \n\nProblem \nProgramming of Arduino controlled traffic-control lights using multi-threading OS functions: \n\nReconsider Example 9.2. How will the OS multithreading functions be programmed? \n\nSolution \n\nStep 1: Program codes for pre-processing declarations for inclusions and  declarations of data types and \nfunctions. \n\n/* include Posix Thread library functions in Linux distribution or include \nfunctions of OS being used */ \n\n# include <pthread.h> \n\n// declare thread delete request false to disable delete of the thread(s) \n\nbool delete_request false \n\n// Define class named LightsThread for Traffic Lights Project \n\n/*-------------------------------------------------------------------------*/ \nStep 2: Program codes for declaring class for a thread and creation of threads. \n\nclass SeqThread : public PThread { \n\n// Each SeqThread has an integer variable ID \n\npublic SeqThread (int threadID); \n\n// Declare loop ( ) either returns a Boolean variable: true or false \n\nprotected bool loop ( ); \n\n// threadID is an integer variable specific to a specific SeqThread object \n\nprivate int threadID; \n\n} \n\nSeqThread : : SeqThread (int threadID) { \n\nthis -> threadID = threadID; // Assign threadID number to this SeqThread \n\n} \n\n/*-------------------------------------------------------------------------*/ \nStep 3: Program codes for setup() for creating a main_thread_list  consisting of numseqthread sequentially \nexecuting threads and write statements in each thread. \n\nvoid setup () { \n\n/* Create specified number of seqthreads.  LightsThread class objects run at \nloop () and return true or false */ \n\n//Define nine Created seqThread (1), seqThread (2), \u2026\u2026seqThread (9) \n\n/* Each thread has ID from 1 to 9.*/ \n\nint numseqthread = 9; //declare number of sequential running threads \n\n/*Write statements for the eight SeqThread objects of class SeqThread  for the \nfunctions in Examples 9.1 and 9.2*/ \n\n/* SeqThread (1) waits of signal 1 and runs Function north_south_Green () and \nFunction east_west_Red () */ \n\n. \n\n352 \nInternet of Things: Architecture and Design Principles \n\n/*SeqThread (2) runs Function delay (30000) and sends signal to enable start \nof next thread (3) */ \n\n. \n\n/*SeqThread (3) waits of signal 3 and runs Function north_south_Yellow () */ \n\n.. \n\n/*SeqThread (4) runs Function delay (10000) and send signals to enable start \nof next thread (5) */ \n\n. \n\n/* SeqThread (5) waits of signal 5, runs Function east_west_Green () and \nFunction north_south_Red () */ \n\n. \n\n/*SeqThread (6) runs Function delay (30000) and sends signal to enable start \nof next thread (7)*/ \n\n. \n\n// SeqThread (7) waits for signal 7 and runs Function east_west_Yellow () \n\n. \n\n/*SeqThread (8) waits for signal 8, runs Function sleep (10000) and at the end \nsends signal to enable start of next thread (9) */ \n\n. \n\n/*SeqThread (9) waits for  signal 9, runs, calls Function test ( ) next and at \nthe end send signal to enable start of thread (1) in next sequences cycle */ \n\n. \n\n/*Use a Boolean variable delete_request false to create the threads and run \nloop */ \n\nif (delete_request = = false ) { \n\nfor (int i = 1; i <= numseqthread; i++) { \n\nmain_thread_list -> add_thread (new SeqThread (i))}; \n\n} \n\n/*delete_request if returned true from the loop then delete the threads to free \nthe memory */ \n\nif (delete_request = = true) { \n\nfor (int i = 1; i <= numseqthread; i++) { \n\npthread_delete (SeqThread (threadID)); } \n\n} \n\n} \n\n/*-------------------------------------------------------------------------*/ \nStep 4: Follows for loop() statements of the program running all nine threads at the  main_thread_list \n\nbool SeqThread :: loop () { \n\n/* OS runs all nine threads at the main_thread_list as long as loop return \nBoolean variable is true*/ \n\n// check for delete_request true \n\nif (delete_request) return false; \n\nPrototyping and Designing the Software for IoT Applications \n353 \n\n/*loops keep running and show status until returns the loop ( ) returns false \n\ninternalLED keep flashing Low from High after the end of a sequence cycle \n\ndue to the test Seqthread (9) */ \n\n} \n\n/*-------------------------------------------------------------------------*/ \n\n9.2.3  Programming Embedded Galileo, Raspberry Pi, BeagleBone and mBed \n\nDevice Platforms \n\nDevelopment of programs is done using an IDE. The cycles of edit-test-debug are used \nuntil the simulated results show the successful test runs of the programs. Following are \nthe details for popular device platforms. \n\nIntel Galileo IDE \n\nIntel Galileo IDE for Windows is downloadable from the Galileo website. 13 Intel Galileo \nand Arduino combined features are: \n\n\u25cf Similarity of IDE with Arduino: Galileo adds Arduino X86 board and new IDE also \nenables firmware upgrading the board. \n\n\u25cf Compatibility: Compatible with Arduino shields and similar ICSP header, serial port, \n14 digital I/O pins and 6 analog inputs \n\n\u25cf Ethernet Library: Compatible in usability with Arduino\u2019s Ethernet library and can \nconnect with HTTP connection using standard WebClient example \n\n\u25cf PCI Express Mini Cards: Can connect to GSM, Bluetooth, WiFi cards using Arduino\u2019s \nWiFi library. \n\n\u25cf USB Host Port: USB is a dedicated port and usable with Arduino USB Host library and \nkeyboard or mouse connection to computers. \n\n\u25cf TWI/I2C, SPI Support, Serial Connectivity and MicroSD Support: Compatible with \nstandard Arduino libraries. \n\n\u25cf Linux distribution running on board: Just 8 MB flash enables node.js (for web projects), \nsound tools: ALSA, video tools: V4L2, Python, SSH, computer vision openCV \n\nRaspberry Pi IDE \n\nRaspberry Pi (RPi) provides a smart-card-size computing \nsystem with media co-processors. A developer can work with \nthe standard keyboard and display.  The Pi supports number \nof languages including Python. Readily available libraries PyPi \nare for RPi programming using Python. RPi supports OS Raspbian Ubuntu distribution \nof Linux (also known as Snappy) and has features of securely running the autonomous \nmachines, M2M and IoT devices. \n\n13 https://downloadcenter.intel.com/download/24355/Intel-Arduino-IDE-1-6-0 \n\nRPi programming using \n\nAdafruit, BlueJIDE or \n\nNinjaIDE \n\n354 \nInternet of Things: Architecture and Design Principles \n\nNumber of IDEs is available for developing computing devices with media capabilities. \nFollowing are the popular ones: \n\nAdafruitIDE is a web-based IDE. 14 The IDE provides a web-based development \nenvironment. RPi connects to LAN and coding can be done using Python, JavaScript \nor Ruby languages. Adafruit also provides a customised OS in place of Raspbian that \nfunctions with keyboard and displays monitor connected with RPi. A secure shell (SSH) \nfor cryptographic network protocol for the application layer enables remote login and \nremote connections of the systems, keyboard and monitor. \n\nBlueJIDE is a Java-based IDE at BlueJIDE. 15 BlueJIDE runs with the help of Java Development \nKit, and apart from this also runs the Java programs including Java 8 on RPi using PI4J \nlibrary. \n\nNinja-IDE source 16 is an IDE which stands for not-just-another IDE. Ninja enables the \nuses of file functions as well building of applications in Python. It runs in cross-platform \nenvironment, RPi as well as Linux, Windows and Mac OSX. Its features are: \n\n\u25cf Ability to create plugins, thus extend code editor functionalities, assistance for project \ndevelopment and load several plugins\u2019 widgets for multi-purposes. \n\n\u25cf Code editing with multiple languages, code assistant for code completion, code \nnavigation, web navigation and imports from anywhere, contextual menu in tabs \nto perform quick actions, code jumps, breakpoints and bookmarks navigation \nimplementation, profile manager, code error finder and static error files detection. \n\n\u25cf Code locator for fast and direct access to a class, function or file with pop up over the \ntext fields. \n\n\u25cf Symbol exporter, files and file usages finder, web inspector and virtualenv have been \nadded, which can be specified in the project creation from Ninja IDE or for an existing \nproject in Project Properties. \n\n\u25cf Supports use of a console for embedded Python. Console manages Python project \nautomatically. It allows the user to perform file management related task in the IDE \nitself and saves the description of the project files itself. \nSection 9.3 will describe Java coding using Eclipse Pi4J. Example 9.10 will explain how \nto program RPi board using eclipse Pi4J implementation. \n\nBeagleBone IDE \n\nRecapitulate Section 8.3.5 for details of BB board for development. BB capabilities extend \nusing capes, just as Arduino by shields. BB extensions provide two 46-pin dual-row \nexpansion headers, motor control, prototyping, battery power, Ethernet, MicroHDMI, \nVGA, LCD, USB host and USB client for power and communication and other functions. \nOne can work with a standard keyboard. \n\nBB supports autonomous machines, M2M and IoT devices. BB has features of running \n\n14 https://learn.adafruit.com/webide/overview \n15 http://www.bluej.org/raspberrypi/index.html \n16 http://ninja-ide.org/ \n\nPrototyping and Designing the Software for IoT Applications \n355 \n\ncloud-based IDE and Node.js web BoneScript library functions. 17 The BB supports \nUbuntu, Android and Debian. Node.js is a JavaScript platform for building scripts using \nrich libraries and networking and real-time capabilities. \n\nBeagleBone development supports usages C/C++ Toolchain with a gcc Cross \nCompiler from linaro.org and the Eclipse IDE in Windows. \n\nmBed IDE \n\nRecapitulate Section 8.3.6 mBed ARM \u00ae has online IDE, an open extensible source code \nwhich includes schematics, software, middleware and C/C++ software platform tools. A \nweb browser is used on computer hosting the IDE that uses ARMCC C/C++ compiler \nat cloud. The tools enable use of MCU firmware core libraries, peripheral drivers, \nnetworking, RTOS runtime environment, build tools and test and debug scripts. The \nIDE enables a developer to develop the applications on mBed platform for the IoT/M2M. \nIDE latest version and appropriate OS are open source Eclipse and include GCC ARM \nembedded tools. \n\nThe mBed OS provides a C++ application framework with the ARM mBed community \nlibraries to create device applications, component architecture and facilitation of \nautomated power management. \n\n9.2.4 \nProgramming Embedded Device Platforms for Internet Connectivity \n\nUsing the Ethernet and WiFi Libraries \n\nArduino Ethernet Library and header files in the library enable the usage of Serial IO \nfunctions between Arduino SPI port, IO utility, Ethernet shield, Ethernet client, Ethernet \nserver, DNS, vDHCP and UDP protocol functions. \n\nUsing IP Library \n\nIP library is used when a set of built-in codes and the codes which enable use of the \nfunctions of the library for creating stack for the TCP/IP protocols based communication are \nneeded. Examples of IP library functions are (i) lwIP (lightweight Internet Protocol) which \nenables TCP/IP communication with the little memory requirements (nearly 40 kB flash/ \nROM and few tens of kB RAM). The library is downloadable from library website 18 and \n(ii) \u03bcIP (micro Internet protocol library functions enable TCP/IP communication with very \nlittle memory requirements (few kB RAM) and for use when buffering of packets is not \nrequired. When a small amount of data communicates then buffering is not required. Usage \nof buffering in communication is for incoming packets and for outgoing unacknowledged \npackets. \n\n17 https://www.c9.io \n18 http://www.savannah.nongnu.org/projrcts/lwip/ \n\n356 \nInternet of Things: Architecture and Design Principles \n\nUsing Cryptographic Library \n\nSecurity of data from embedded device platforms is of high \nimportance in web applications and services. Assume that the \ndevice-end has a user ID, say A1 for authentication at another \nend. A cloud, web application or service end has an application \nID, say A2 for authentication at the user\u2019s end. \n\nThe A1 needs to store at the application or service end database and A2 needs to store \nat the user-end database. A1 communicates for authentication at the other end. The \napplication matches received A1 with the database stored A1. If a match is successful, \nthen the user end stands authenticated. \n\nTwo security risks are\u2014one is during communication to the other end, some system \nin-between, such as, a switch or router or server S1 reads A1 or A2 received from another \nend and resends the same to the authentication end. Another security risk is that some \nsystem modifies A1. The application will authenticate the S1 authentication code in place \nof the user end. Similarly, the user end can wrongly authenticate the application or get a \nmodified text. \n\nTwo basic requirements are thus authentication and encryption of data. Cryptographic \nlibrary is used when a set of built-in codes and the codes which enable use of the \ncryptographic functions, like OAuth 1.0 protocol functions are needed. The OAuth 1.0 \nfunctions enable securing the data from modifications or replaying that by some other \nsoftware. \n\nA library, called cryptosuite is downloadable online. 19 Encryption key length can be \n128, 192 or 256. Data encryption can use AES256 (Advanced Encryption Standard 256-bit \nencryption key length) or DES (Data Encryption Standard). Arduino AES 256 library is \ndownloadable and used for Arduino boards. \n\nAdding Security and Authentication \n\nSecuring Communication of Authentication Code (Secret Key) \n\nSecurity adds in the authentication code A1 when hash of A1 \nH (A1) communicates to the application end and application \nmatches the stored H(A1) with the received H(A1). \n\nSecurity adds by communicating hash of A1 or secret key (a \ntext string) in place of communicating plain text string. A function, called hash function \ncreates a fixed length string, called hash of the input string, for example of A1. The H(A1) \nuses the original string, say A1. User communicates H(A1) in place of original A1. \n\nThe application or service end stores the H(A1) for identifying string A1. A1 cannot be \nidentified from stored H(A1) when that mismatches with the received H(A1) at that end. \nAssume H(A1) changes to H\u2019(A1) due to in-between modification. The received H\u2019(A1) \n\n19 http://code.google.com/p/cryptosuite \n\nLibrary functions for \nsecure communication \n\nfor the IoT \n\nAuthentication using a \nsecret key and a hash \n\nfunction in place of \ncommunicating a plain \n\ntext string \n\nPrototyping and Designing the Software for IoT Applications \n357 \n\nwill not match with stored H(A1). Therefore, the authentication code of user A1 will not \nbe identified. \n\nExamples of the usages of hash function are SHA1/SHA256 secured hash algorithms or \nMD5 message digest algorithm. Example 9.8 lists the steps involved in the method. \n\nExample 9.8 \n\nProblem \nUsing Hash algorithm for secure communication of authentication codes: \n\nHow will the authentication code be created for communicating securely from an embedded device platform \nusing SHA1 hash function? \n\nHow does the SHA1 used at the application? \n\nSolution \n\n(i) The statements for authentication code from an embedded device platform using a hash function are \n\nas follows: \n\nStep 1: Statements are preprocessor commands, declarations of data types and functions and include the \nrequired library files. \n\n/*Cryptographic library functions */ \n\n/*Include <sha1.h>, <sha256.h> or <md5.h> header files*/ \n\n#include <sha1.h> \n\n/*IO utility functions*/ \n\n#include <util.h> \n\n/* The authentication codes declares as set of unsigned integer of 8-bit each \nat a pointed address */ \n\nuint8_t *authcode \n\n/* The hash authentication codes declares as set of unsigned integer of 8-bit \neach at a pointed address*/ \n\nuint8_t *hashauthcode \n\n// Assign Values to authcode \n\n. \n\n. \n\n// Write other preprocessor statements \n\n. \n\n. \n\n} \n\n/*************************************************************************/ \nStep 2 is as follows for setup() statements for initialising SHA1, creating hash code and setup GPIO pin \nmodes. \n\nvoid setup ( ) { \n\nsha1.init ( );// initializes SHA1 \n\nhashauthCode = sha1.result ( ); // creates hash of authentication code, authCode \n\n358 \nInternet of Things: Architecture and Design Principles \n\npinMode (internalLED, OUTPUT); \n\ndigitalWrite (internalLED, HIGH); \n\n//Write statement for display on Serial Monitor of authentication code \n\nSerial.begin (9600); \n\n. \n\n. \n\n/* Write Statements for display of hash of the authentication code a */ \n\n.. \n\n} \n\n/************************************************************************/ \nStep 3 is write loop() statements for communication of the code, and test. \n\nvoid loop () { \n\n/* Write Statements for communication of hash of the authentication code */ \n\n. \n\n. \n\ntest ( ); \n\n} \n\n/************************************************************************/ \n\n(ii) The application receives hashauthCodeNew in place of hashauthCode. Then, a Boolean variable mismatch \n\nwill be equal to true when the authentication fails. The preprocessor and loop() statements are: \n\n/* First include the functions from Cryptographic library using pre-processor \nstatement */ \n\n#include <sha1.h>/* or #include <sha256.h> or <md5.h>*/ \n\n/*IO utility functions*/ \n\n#include <util.h> \n\n/* The hash of authentication code used to check the match and new hash received \nare sets of unsigned integer of 8-bit each at a pointed addresses*/ \n\nuint8_t *hashauthcode, *hashauthcodeNew \n\n/*-------------------------------------------------------------------------*/ \n\nloop ( ) { \n\n/* Write statements for receiving the hashauthCodeNew */ \n\n. \n\n/* Write statements for matching the hashauthCodeNew with stored hashauthcode*/ \n\n. \n\n/* Write statements for receiving the hashauthCode*/ \n\nIf (match_request = true) { \n\nif (hashauthCodeNew == hashauthCode) { \n\nmismatch = false; \n\nPrototyping and Designing the Software for IoT Applications \n359 \n\nmatch_request = false; /* Matching is only once and thus cancel the match \nrequest */ \n\n} else \n\n{mismatch = true;} \n\n. } \n\nData Encryption and Decryption \n\nData needs protection from read and use by an in-between system. Encryption ensures \nthe protection needs. Uses of standard algorithms, such as AES128, AES192, AES256 or \nDES enable the encryption and decryption. Example 9.9 explains the statements in C/C++ \nfor using the AES256 encrypting and decrypting algorithms. \n\nExample 9.9 \n\nProblem \nEncryption of device end messages and decryption at application end: \n\n(i)  How is the encrypted message or sensed data created for secure communication from an embedded \n\ndevice platform? \n\n(ii) How does the message decrypt at the application end? \n\nSolution \n\n(i) The statements for authentication code from an embedded device platform using a hash function are: \n\nStep 1: Preprocessor commands, declarations of data types and functions and include the required library \nfiles. \n\n/* First include the functions from Cryptographic library using pre-processor \nstatement */ \n\n#include <aes256.h> \n\n/*IO utility functions*/ \n\n#include <util.h> \n\n/* Contextual parameters Data type declaration */ \n\naes256_context context / * Number of contextual parameters required that enables \nAES algorithm execute. These save at the pointed address context*/ \n\n. \n\n. \n\n// Write other preprocessor declarations \n\n. \n\n. \n\n} \n\n/*************************************************************************/ \n\n360 \nInternet of Things: Architecture and Design Principles \n\nStep 2 is as follows for setup() statements for 256-bit key and message string. \n\nvoid setup ( ) { \n\nuint8_t key [ ] = {\u2026, \u2026., \u2026.., \u2026\u2026, \u2026\u2026}/* Curly bracket has key of thirty two \n8-bit unsigned integer numbers, each number separates by a comma. */ \n\naes256.init (&context, key);// initializes AES256 \n\nchar *message = \u201c\u2026\u2026\u2026\u201d// Assign Message characters for communication \n\n/*Write statement for display on Serial Monitor of authentication code */ \n\naes256_encrypt_ecb (&context, (uint8_t) message); \n\nSerial.begin (9600); \n\n. \n\n. \n\n/* Write Statements for display of encrypted message */ \n\n.. \n\n} \n\n/*************************************************************************/ \n\nvoid loop () { \n\n/* Write Statements for communication of encrypted message */ \n\n. \n\n. \n\ntest ( ); \n\n} \n(ii) Assume that the application receives the encrypted message. The statements for decrypting can be: \n\n#include <aes256.h> /* First include the functions from Cryptographic library \nusing pre-processor statement */ \n\n#include <util.h> /*IO utility functions*/ \n\naes256_context context / * Number of contextual parameters required during \nexecution of AES algorithm. These save at the pointed address context */ \n\nchar *message = \u201c\u2026\u2026\u2026\u201d// Assign Message characters for communication \n\n. \n\n// Write other preprocessor statements \n\n. \n\n. \n\n} \n\n/*************************************************************************/ \nStep 2 is as follows for setup() statements for 32 bit key. \n\nvoid setup ( ) { \n\nPrototyping and Designing the Software for IoT Applications \n361 \n\nuint8_t key [ ] = {\u2026, \u2026., \u2026..}/* Curly bracket has key of thirty two 8-bit \nunsigned integer numbers, each number separated by comma. */ \n\naes256.init (&context, key) ;// initializes AES256 \n\nSerial.begin (9600); \n\n. \n\n. \n\n} \n\nloop ( ) { \n\n// Write statements for receiving the message for decryption \n\n. \n\n. \n\naes256_decrypt_ecb (&context, (uint8_t) message); \n\naes256_done (&context) ; /* It e nds the initialized AES256*/ \n\n. \n\n/* Write Statements for display of decrypted message on serial monitor*/ \n\n.. \n\n// Write statements for test ( ). \n\n} \n\nReconfirm Your Understanding \n\n\u25cf IDE enables development of embedded device software. Arduino IDE has simplicity and is based on \nprocessing language and wiring library functions. \n\n\u25cf Simplicity of Arduino is clear from the fact that only two functions are necessary to define the \nexecutable program functions for the device, namely, setup() and loop() . A serial monitor at the \nIDE consisting computer enables the results from the serial port at a device platform. The developed \nsoftware at the computer also downloads into the device using the port. \n\n\u25cf A traffic-lights monitoring program shows how to (i) program setup() and loop() functions using \nArduino IDE C/C++ for programming the GPIO pins, (ii) control the intervals between three states of \neach pathway using delay() function, and (iii) test using serial monitor and testing of the program \nfunctions. \n\n\u25cf Number of library functions provide ease in programming. Usages of timer and software serial \nlibraries show how to program for (i) the timer functions, (ii) reading of RFID ID tag using UART \nfunctions, and (iii) I2C communication between sensor communicating sensed data using I2C and \nArduino I2C port. \n\n\u25cf When multiple threads of a program execute on a device platform, an OS provides for system calls \nfor these functions. Rewriting of Arduino controlled traffic control lights monitoring program shows \nhow to program using multi-threading OS functions. \n\n\u25cf Intel-Arduino IDE functions enable development of embedded device software for Intel Galileo \ndevice platform. \n\n362 \nInternet of Things: Architecture and Design Principles \n\n\u25cf OS Raspbian Ubuntu distribution of\u00a0 Linux, Snappy enables programming for secure running of \nautonomous machines, M2M and IoT devices using RPi. \n\n\u25cf A web-based IDE Adafruit enables development of embedded device software for RPi as well as BB. \n\n\u25cf BlueJIDE is a Java based IDE for RPi. \n\n\u25cf Ninja-IDE is IDE for RPi enabling development of embedded device software at Windows, Mac OX and \nLinux cross platform environments. The Ninja enables file functions as well for building applications \nin Python using an embedded Python console. \n\n\u25cf IDE and OS distributions for BB enable the embedded software development. \n\n\u25cf Things communicate to the Internet using functions at Ethernet, WiFi and IP. \n\n\u25cf Things communicate securely using crypto-library functions. \n\n\u25cf The crypto-library functions enable the programming, secure communication of data for IoT. Two \nsecurity risks are taken care by (i) using a secret key and its secure communication, (ii) using \nencryption and decryption functions, such as AES128, AES192, AES256 or DES). \n\nS elf-Assessment E xercise \n\n1. Why does prototyping embedded software become easy using an IDE for a \n\ndevice platform? \n2. List the steps used in the traffic light program, function loop() in Example 9.1. \n3. Write a program to read three digital inputs, viz. 1-bit for streetlight working \n\nstatus (Yes or No), 1-bit for ambient surrounding light status (insufficient or \nnot insufficient) and three bits for traffic density level using Arduino IDE and \ndevice platform. \n4. How will you use the library functions to call a function action1() after a preset \n\ninterval of 1s and another after 3s from the start? Use Example 9.4 as hint. \n5. List the soft serial library functions for Arduino and write their usages. \n6. When does a device platform use UART, I2C and SPI bus for communicating \n\nwith a sensor? \n7. Using Example 9.7, write the advantages of using the threads functions of the \n\nOS. \n8. List additional features in Intel Galileo device platform over Arduino. \n9. Tabulate for comparing the usages and features of IDEs for Raspberry Pi. \n10. Show the steps in software for communicating the data stores at the device \n\nplatform over the Internet using Ethernet library functions using Example 8.5. \n11. List security risks when communicating a secret key over Internet. \n12. List and write usages of the cryptolibrary functions for secure communication \n\nof the data over Internet. \n\n\u2605 \n\n\u2605\u2605 \n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605 \n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605\u2605 \n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605 \n\u2605\u2605\u2605 \n\nNote: \n\u2605 Level 1 & Level 2 category \n\n\u2605\u2605 Level 3 & Level 4 category \n\n\u2605\u2605\u2605 Level 5 & Level 6 category \n\n\n![Image](/src/assets/generated_images/iot2_p389_i0.png)\nPrototyping and Designing the Software for IoT Applications \n363 \n\n9.3 \nDEVICES, GATEWAYS, INTERNET AND \nWEB/CLOUD SERVICES SOFTWARE- \nDEVELOPMENT \n\nRecall Chapter 3\u2014connected devices in IoT/M2M use the \nCoAP and LWM2M web-communication protocols and \nmessaging-protocols, such as message-cache, Message Queue \nTelemetry Transport (MQTT), and Extensible Messaging and \nPresence (XMPP). MQTT is a publish/subscribe (Pub/Sub) \nprotocol. The devices connect, network and communicate over the web. They use the \ncommunication gateway, SOAP, REST, RESTful HTTP and WebSockets. Figure 3.1 showed \nthe connected devices, protocols and usages of the Internet in IoT/M2M applications and \nservices. \n\nFigure 9.1 shows five levels for software development for applications and services in \nthe IoT or M2M. The software needs are for the devices, local network, gateway, cloud/ \nweb connectivity and web/cloud APIs. \n\n\u2026\u2026\u2026 \n\nDevice 1 \n\n\u2026\u2026.. \n\nDevice 2 \n\nDevice i \n\n10s of Bytes \n\n10s of Bytes \n\n10s of Bytes \n\n100s of Bytes \n\nServer \n\n1: Physical/Data Link \nand Adaptation Layers \nSoftware using IDE \n\nDTLS \n\nUDP \n\nDTLS \n\nIP \nTLS \n\nHTTP \nServer \n\nWeb Object \nWeb Object \n\nClient \n\nServer \n\nTCP \n\nROLL \n\nhttp://....... \n\n. \n\nhttp://........ \n\nlwm2m:// or coap://........ \n\nMQTT, \n\nCoAP \nLWM2M \n6LowPAN, \nZigBee NAN \n\nBluetooth \n\nSmart IP \nZigBee IP \n\nIP \nLPWAN \n\nHTTP \nClient \n\n3: Network and Transport \nLayers Software \n\n10s of Bytes \n\n1000s of Bytes \n\nUDP \nClient \n\nlwm2m:// or coap://........ \n\n4: Application Support \nLayer APIs/Software \n\n5: Application Layers APIs /Software \n\n2: IoT or \nM2M Area \nLocal Network \nand Gateway \nSoftware \n\nWireless: Bluetooth LE, ZigBee, LPWAN, \nWi-Fi or Wired: UART, USB, I2C, SPI, \nSDIO or Ethernet \n\nWeb \nConnectivity/ \n\nCloud \nConnectivity, \n\nAPIs, Web \nApplications, \nWebSockets, \n\nAnalytics, \nVisualisation \n\nKnowledge \n\nDiscovery \n\nSoftware \n\nFigure 9.1 \nFive levels for software development for applications and services for IoT or M2M \n\nSoftware, such as Eclipse IoT , enable the development of \nsoftware for the first, second and third levels. The software \nenables the device gateways connectivity to the Internet and \ncloud server. Eclipse IoT enables open source implementations \nof IoT protocols. The implementable protocols include MQTT \n\nAnalyse and \n\nprogram the \ndevices, gateways, \nInternet connectivity, \n\nweb and cloud \napplications using \n\nthe open-source \nimplementations of \n\nEclipse IoT stack \n\nLO 9.2 \n\nEclipse IoT stack for \nfive levels of software \n\ndevelopment for the \n\napplications and \nservices in IoT/M2M \n\n364 \nInternet of Things: Architecture and Design Principles \n\nCoAP, OMA-DM and OMA LWM2M and Internet connectivity protocols (Sections 3.2, 3.4 \nand 4.2). \n\n9.3.1 Use of Software Stack for an Intended Complete Solution \n\nSection 9.2 discussed the first-level software. Now consider the software for higher levels. \nEach level has characteristic complexity and fragments. Recall Sections 3.3 to 3.5. The \nconnected devices use a variety of protocols, such as LWM2M, CoAP, MQTT, and methods \nfor connecting to the web. Web communication uses the Gateway, SOAP, REST, RESTful \nHTTP and WebSockets functions. \n\nA stack is a full set, consisting of frameworks, applications and services that are \nminimum needs for intended complete solution. Following sections describe Eclipse IoT \n(www.iot.eclipse.org) stack for end-to-end IoT/M2M solutions. \n\n9.3.2 \nEnd-to-End IoT Solutions with Java using Eclipse IoT Stack \n\nOpen Services Gateway Initiative (OSGi) (now OSGi Alliance) provides and maintains \nopen standard specifications.  OSGi describes the specification of management of Java \npackages/classes in a modular system, which enables the implementation of a complete \nand dynamic component model.  A component means software which can reuse a core \nset of frameworks and services for provisioning the solutions. The components and \napplications deploy in the form of bundles and can be remotely installed, started, stopped, \nupdated, and uninstalled without requiring system reboot. 20 \n\nOSGi in addition gives specifications for service platforms in Java language. The \ncomponent or application life-cycle management uses a set of APIs. When a service \nregisters, then service bundles detect the deletion or addition of new services and get \nadapted. \n\nOSGi in addition to original focus, now has evolved \nspecifications far beyond the gateways, such as eventing , \nconfiguration management , clock , crypto (aes, base64, sha-1), \ngeolocatio n data, cloud and application servers and services for the \nconnect and manage functions. \n\nOSGi thus find applications for the management of Java packages and classes. Examples \nof applications and services are fleet management, automobiles, automobiles, smart \nphones and now in IoT/M2M solutions. \n\nEclipse IDE is an application using OSGi specifications. Eclipse open IoT stack is a set of \nJava frameworks, protocols, development tools and OSGi services. The features of Eclipse \nIoT stack are: \n\n\u25cf Provides open source specifications which are as per open OSGi standard specifications \n\n20 https://en.wikipedia.org/wiki/OSGi \n\nOSGi service functions \n\nfor Clock, Crypto \n(AES, base64, SHA-1), \n\nGeolocation, Data and \n\nCloud Services \n\nPrototyping and Designing the Software for IoT Applications \n365 \n\n\u25cf Provisions for simpler open source implementations, and programs, services and \nbundles development using the open source Java frameworks and services \n\n\u25cf Consists of the components and frameworks for IoT solutions. The stack takes care of \nthe complexity of creating IoT solutions and enables fast development of the solutions \n\n\u25cf Provisions for open source technologies which enables easy programming in Java for \nthe device platforms, and running the codes in JVM or Eclipse Concierge (a lightweight \nimplementation of OSGi runtime) \n\n\u25cf Enables usages of protocol functions provided in lightweight M2M (OMA M2M \nstandard), MQTT (OASIS IoT standard), CoAP (IETF IoT standard) and standard \nnetwork protocols. The functions provide the connectivity and interoperability of the \ndevice gateways \n\n\u25cf Provisions the IoT gateway services for remote management and applications \nmanagement \n\n\u25cf Provisions for new solutions for devices connectivity to the Internet and the remote \nmanagement and application management functions and APIs for using server or \ncloud provided functions \n\n\u25cf Support of large number of institutions including Cisco and IBM \nEclipse IoT stack includes device platform for physical/data-link and adaptation layers. \nTable 9.1 gives the implementations and frameworks for ( Gather + Consolidate ) and local \nnetwork and gateway software ( connect ) levels. \n\nTable 9.1 \nEclipse implementations and frameworks included in Eclipse IoT stack \n\nEclipse Implementation/Framework \nDescription \n\nEclipse Pi4J \nA framework based on WiringPi and PiFace, Gertboard and \nother shields, which support the I2C/SPI/GPIO interfaces in \nsensors, actuators and device platforms, for the RPi. Similar \nframework is for BB platform and capes used with BB. \n\nEclipse Koneki \nA set of functions for embedded Lua language based \ndevelopment of device applications. \n\nEclipse Mihini \nAn embedded Lua runtime which provides provisions for \nhardware abstraction and other services. \n\nEclipse Krikkit \nProvisions a system of rules when programming edge devices. \nFor example, when configuring the device platforms. \n\nIt is beyond the scope here to cover each Eclipse IoT component for device platforms. \nFollowing section describes the usages of Pi4J components. \n\n366 \nInternet of Things: Architecture and Design Principles \n\nEclipse.Pi4J \n\nRPi board has 8 \u00d7 GPIO plus the following, which can also be used as GPIO: UART, \nI2C bus, SPI bus with two chip selects, I2S audio, +3.3 V, +5 V and ground pins. Example \n9.10 gives an Eclipse Pi4J implementation of GPIO/I2C/SPI protocols using RPi device \nplatform. \n\nExample 9.10 \n\nProblem \nProgramming of RPi board using the eclipses Pi4J implementation: \n\nAssume RPi board (Section 8.3.1) as embedded device platform. Assume that GEN0 to GEN6 are the GPIO \ndedicated pins in a given board. \nHow are GPIO pins setup using Pi4J?  When a GPIO_01 pin connects status LED, how will the port GEN_1 LED \nbe programmed? When a GPIO pin connects traffic red, yellow and green lights, how will the port GPIO_02, \nGPIO_03 and GPIO_04 be programmed? \nSolution \n\nExample of program codes which embeds onto RPi are as follows: \n\nStep 1 statements are constructors and methods. \n\nimport // Import Pi4J from www.eclipse.org \n\n/* A gpio object specified. */ \n\nGpioController gpio = GpioFactory.getInstance ( ); \n\n/* gpio object method for RPi pin GPIO_01 named status LED setting in state \nHIGH. */ \n\nGpioPinDigitalOutputPin pin01 = gpio.provisionDigitalOutputPin (RaspiPin, \nGPIO_01, \u201cstatusLED\u201d, PinState.HIGH); \n\n/* pin01 to be set LOW after 2000 ms) */ \n\nThread.sleep (2000); \n\npin01.low ( ); ; \n\n/* Return */ \n\ngpio.shutdown ( ); \n\n/*******************************************************************/ \nStep 2 statements are gpio object specifications using constructors, and methods of sleep, low and high. \n\n/* Four gpio pin objects, pin02, pin03 and pin04 specified. */ \n\nGpioController gpio = GpioFactory.getInstance ( ); \n\n/* gpio object initialization methods for RPi pin GPIO_02, named as REDLED \nsetting in state HIGH and Other two in LOW states at the start. */ \n\nGpioPinDigitalOutputPin pin02 = gpio.provisionDigitalOutputPin (RaspiPin, \nGPIO_02, \u201cREDLED\u201d, PinState.HIGH); \n\nPrototyping and Designing the Software for IoT Applications \n367 \n\nGpioPinDigitalOutputPin pin03 = gpio.provisionDigitalOutputPin (RaspiPin, \nGPIO_03, \u201cYELLOWLED\u201d, PinState.LOW); \n\nGpioPinDigitalOutputPin pin04 = gpio.provisionDigitalOutputPin (RaspiPin, \nGPIO_04, \u201cREDLED\u201d, PinState.LOW); \n\n/* pin02 to be set LOW after 30000 ms and pin03 to be set HIGH) */ \n\nThread.sleep (30000); \n\npin02.low ( ); \n\npin03.high ( ); \n\n/* pin03 to be set LOW after 5000 ms and pin04 to be set HIGH) */ \n\nThread.sleep (5000); \n\npin03.low ( ); \n\npin04.high ( ); \n\n/* One Cycle completes on one pathway */ \n\nEclipse IoT stack includes gateway, network, transport and application-support layers. \nTable 9.2 gives the implementations and frameworks for gateway software (connect) and \nnetwork and transport layers software (Connect + Assemble + Manage). \n\nTable 9.2 Eclipse implementations and frameworks included in Eclipse IoT stack for gateway, network, \n\ntransport and Application-Support layers 21 \n\nEclipse \nImplementation/ \nFramework \n\nFunctions for IoT/M2M \nDescription \n\nEclipse Wakkamma \nLWM2M clients with \nLWM2M server \n\nA set of library functions for LWM2M in a \u2018C\u2019 \nimplementation. \n\nEclipse Californium \nCoAP clients. Secure DTLS \nand CoAP server \n\nAn implementation in Java of CoAP, including DTLS \nfor IoT security.) A Californium-based sandbox \nserver can register the CoAP clients. The server \n(CoAP://iot.eclipse.org:5683) also interacts with \nCoAP clients. \n\nEclipse Lehshan \nLWM2M clients. Secure \nDTLS and LWM2M \nsandbox server \n\nJava implementation of LWM2M for device \nmanagement in Java and includes DTLS for IoT \nsecurity. A Lehshan-based sandbox server can \nregister the LWM2M clients. The server (coap:// \niot.eclipse.org:5684) interacts with the client \nWeb UI and REST API. The server interacts with \nregistered LWM2M clients. 21 \n\n21 http://www.iot.eclipse.org/lwm2m \n\n( Contd. ) \n\n368 \nInternet of Things: Architecture and Design Principles \n\nEclipse Moquette \nC MQTT clients at devices \nand applications in pub/ \nsub mode using TCP and \nSandbox server \n\nAn implementation in \u2018C\u2019 of the publish/subscribe \nprotocol MQTT using TCP. A sandbox server (tcp:// \nm2m.eclipse.org:1883).at \ncloud/web \ninteracts \nwith MQTT clients at an application running at a \ncomputer/tablet/ mobile phone. \n\nEclipse Paho \nMQTT clients at devices \nand applications in pub/ \nsub mode using a MQTT \nBroker \n\nA Java implementation of the MQTT client and \nMoquette which uses a Java MQTT broker (m2m. \neclipse.org/paho); Paho also uses the JavaScript, \nLua, Python, dot Net, dot net compact, dot net \nmicro, Windows Phone, Android. \n\nEclipse OM2M \nM2M TEST APIs network, \ngateway and sandbox \nserver interactions \n\nAn implementation of the ETSI M2M standard. It \nprovides a horizontal service capability layer (SCL) \nthat can be deployed in an M2M network, gateway \nor device. M3DA sandbox server (http://iot. \neclipse.org:44900) interacts with REST API (http:// \niot.eclipse.org/m3da) \n\nEclipse Ponte \nM2M CoAP and MQTT \ngateways and MQTT- \nMQTT broker and MQTT- \nCoAP broker \n\nA framework based on Java and OSGi services for \nIoT and M2M Gateways. Ponte gateway includes \nbridge between the M2M/IoT protocols, for \nexample, between MQTT and CoAP protocols \nusing devices to the Web. \nPonte broker functions connect the MQTT device \nplatform applications network at one end with \nthe CoAP device platform applications network at \nanother end (Section 3.3). \n\nEclipse Jetty \nWebSockets \nbi-directional \ncommunication \n\nA set of Java methods and annotations for \nWebSocket objects creation and sessions (Sections \n3.4.5 and 9.4)* \n\nEclipse Kura \nGateways. Services, \ncloud connectivity, \nmanagement of device, \nnetwork configuration \nand application \n\nA set of OSGi based application framework and \nservices for building IoT and M2M gateways. \nServices include (i) device abstraction, CAN bus \nfor automotive embedded devices, configuration \nmanagement, \nand \nintegrated \ndevice \ncloud \nfunctions, and (ii) provides application portability, \nmodularity and application management and \nprovisions for built-in OSGi services for IoT apps. \n\n* English meaning of annotation is addition of notes to a page or diagram or picture or painting for better \nunderstanding. \n\nPrototyping and Designing the Software for IoT Applications \n369 \n\nCovering all components of Eclipse IoT here is beyond the scope of this book. The \nfollowing section describes the usages of Paho. \n\nEclipse.Paho \n\nRecall Section 3.3.1. A communication mode is request-response \nmode. An HTTP client makes a request to a server which sends a \nresponse. The client is said to pull the required messages (data) in \nresponse. When physical devices, such as streetlights exchange \ndata between each other, or when other system, such as a central \nserver or controller, controls them, then data exchanges are just \n10s of bytes. The devices need a lightweight method in place of \nthe HTTP. \n\nA communication mode is pub-sub mode. MQTT protocol provides for three objects: \nMQTT clients at the devices, MQTT broker and MQTT clients at the application(s). Assume \nthat a device, such as a streetlight deploys MQTT client for sending the sensed data and \nreceives commands from the application end through a broker (intermediate server). \nMQTT-client, unlike HTTP, does not have to pull the messages (commands) which the \ndevice needs for its control. An MQTT broker pushes the messages to the client, provided \na client has subscribed to those. A broker functions like a dashboard, where the messages \nfirst reach from the sources and from there the messages then dispatch to the subscribers \n(ones who makes a request for the messages being dispatched). \n\nEach MQTT client may be required to use an always connected UDP (or TCP) connection \nwith a broker. The MQTT broker uses buffers for all messages. This facilitates the dispatch \nwhen a client reconnects after an interruption. An interruption is always a possibility in \nROLL environment. \n\nRecall the example of Internet of Streetlights (Example 1.2) and devices connectivity \nusing five levels (Figure 9.1). Consider use of MQTT Pub/Sub protocol for the connectivity \nbetween devices and the application layers. Figure 9.2 shows the connected streetlights \npublishing the sensed data and subscribing for the control data, and using MQTT \nclients during communication with the application layer. The figure shows that MQTT \nclients communicate through an MQTT broker with other clients at the devices or at \nthe applications and central controller. The figure also shows sequence 1, 2, 3 and 4 for \nmessage exchanges. \n\nExample 9.11 gives an Eclipse Paho Java implementation of MQTT clients broker \narchitecture. \n\nProgram \nimplementation in \nPub/Sub mode for \nthe MQTT clients and \n\nMQTT broker using \n\neclipse Paho \n\n370 \nInternet of Things: Architecture and Design Principles \n\nExample 9.11 \n\nProblem \nCommunication of sensed data to the applications and central controller for the control of streetlights \n(Example 1.2) using the Eclipse Paho implementation of MQTT: \n\n(i) Import Java packages for MQTT clients, broker and applications and the Publisher and Subscriber \n\nclasses for constructing the objects for publishing sensed data of the devices, such as streetlights. \n\n(ii) Implement the codes for publisher class for control data from the central controller and sensed data \n\nfrom the devices. \n\n(iii) Implement the codes for subscriber class for subscribing of sensed data by the application/central \n\ncontroller. \n\n(iv) Implement the codes for subscriber class for subscribing of control data by the device clients \n\n(v) Implement the codes for observing \u2018Last Will and Testament\u2019 (LWT) message on disconnection/failure \n\nof communication of messages on topic sensed data and control data and communicating again on \nreconnection using MQTT broker. \n\n(vi) Implement the codes for threads for publishing the messages for the sensed data. For example, for \n\ntraffic presence and lighting needs in Internet of Streetlights. \n\nApplication Layer \n\nDevices using \nMQTT Clients \n\nStreetlight \n\nGroup 1 \nDevice 1 \n\nStreetlight \n\nGroup m \n\nDevice i \n\n1:Published \nSensed data \n10s of Bytes \n\n4:Subscribed \nControl data \n10s of Bytes \n\nPublished \nSensed data \n10s of Bytes \n\nSubscribed \nControl data \n10s of Bytes \n\nPhysical/Data Link \n\nLayer \n\nAdaptation \n\nLayer \n\nNetwork and \nTransport Layers \n\nLayer \n\nApplication \nSupport Layer \n\nIoT or M2M \n\nArea Local \nNetwork and \n\nGateway \n\nNetwork \n\nand \nTransport \n\nMQTT \n\nbroker \n(m2m. \neclipse. \n\norg/ \npaho) \n\n3:Published \nControl Data \n\nfor the \nDevices \n\n2:Subscribed \n\nSensed data \n\nof Devices \n\nApplications \n\nand Central \n\nController \n\nApplications and \n\nServices \nLayer MQTT Clients \n\nFigure 9.2 Connected streetlights publishing the sensed data, subscribing for the control data and \n\nusing MQTT clients during communication with the application layer MQTT clients through \nan MQTT broker \n\nPrototyping and Designing the Software for IoT Applications \n371 \n\n(vii) Implement the codes for publisher and subscriber threads at the devices and application in example \n\nof Internet of Streetlights \n\nSolution \n\nAssume that a Java package is used for \u2018Internet of Streetlights\u2019: \nStep 1: The program  implements in Paho that imports following packages. \n\nPackage org.eclipse.pahoIoTStreetLights; \nimport org.eclipses.paho.client.mqttv3.MqttClient; \nimport org.eclipses.paho.client.mqttv3.MqttException; \n\nimport org.eclipses.paho.client.mqttv3.MqttMessage; \nFollowing are the sets of coding required: \n\n(i) Publisher class for constructing the objects for publishing sensed data of the devices, such as \n\nstreetlights \n\n/* Let first step is that within the class Publisher, declare URL of the MQTT \nBroker and create instance of class MQTTClient . Use MAC Address as Client_ID \nfor publisher ID and the initialization of the MqttClient instance is as per \nfollowing code. Use -pubDevice as a suffix for the Client_Id. Following is \nthe Java code for that.*/ \n\npublic class Publisher { \n\npublic static final String MQTT_BROKER_URL = \u201ctcp://broker.mqttdashboard. \ncom:1883\u201d; \n\n/* client is the instance of MqttClient */ \n\nprivate MqttClient client; \n\npublic Publisher() \n\n{ \n\nString p1 = \u201c-pubDevice\u201d; \n\n/* Declare clientDevice_ID using method getMacAddress ( ). */ \n\nString clientDevice_Id = Utils.getMacAddress() + p1; \n\ntry { \n\nmqttClient = new MqttClient(MQTT_BROKER_URL, clientDevice_Id); \n\n} \n\ncatch (MqttException e) { \n\n/* Write codes for callback method */ \n\n/* On exeception, Assume that callback method is print the stack trace . */ \n\ne.printStackTrace(); \n\nSystem.exit(1); \n\n} \n\n} \n\n} \n\n/*********************************************************************/ \n\n372 \nInternet of Things: Architecture and Design Principles \n\n(ii) Publisher class for publishing control data at the application/central controller \n\nLet next step be use MAC Address as Application ID for subscriber ID and the initialisation of \n\nthe\u00a0MqttClient\u00a0instance is almost the same as above publisher above code, except that use-pubApp\u00a0as \na suffix for the Client_Id. \n\n(iii) Subscriber class for subscribing of sensed data by the application/central controller \n\nLet next step be use MAC Address as Application ID for subscriber ID and the initialisation of \n\na\u00a0MqttClient\u00a0instance is as per publisher codes, except that use - subApp\u00a0as a suffix for the Application_ \nId. Following is the Java code for that. \n\npublic class Subscriber { \n\npublic static final String MQTT_BROKER_URL = \u201ctcp://broker.mqttdashboard. \ncom:1883\u201d; \n\n/* client is the instance of MqttClient */ \n\nprivate MqttClient client; \n\npublic Subscriber () \n\n{ \n\nString s1 = \u201c-subApp\u201d; \n\n/* Declare client at the Application_ID using method getMacAddress ( ). */ \n\nString Application_ID = Utils.getMacAddress() + s1\u201d; \n\ntry { \n\nmqttClient = new MqttClient(MQTT_BROKER_URL, Application_Id); \n\n} \n\ncatch (MqttException e) { \n\n/* Write codes for callback method */ \n\n/* On exeception, Assume that callback method is print the stack trace . */ \n\ne .printStackTrace(); \n\nSystem.exit(1); \n\n} \n\n} \n\n} \n\n/*********************************************************************/ \n(iv) Subscriber class for subscribing of control data by the device clients \n\nLet the MAC Address be used as Client_ID for subscriber ID and the initialisation of the\u00a0MqttClient\u00a0instance \n\nis almost the same as above subscriber code, except use\u00a0-subDevice\u00a0as a suffix for the Client_Id. \n(v) Observing LWT message on disconnection/failure of communication of messages on topic sensed data \n\nand control data \n\nA disconnection is feasible. A broker needs to detect disconnection by a client. If the clientDevice \n\nhas set a subscription to a message for a topic (for example, SensedData), then when the device \nreconnects, the broker sends \u2018LWT\u2019 message string to the topic \u2018SensedData\u2019 on reconnection. Similarly, \nIf the clientApplication has set a subscription to a message for a topic (for example, ControlData), \nthen when application reconnects, the broker sends \u2018LWT\u2019 message string to the topic \u2018ControlData\u2019 on \nreconnection. \n\nPrototyping and Designing the Software for IoT Applications \n373 \n\n\nThe following code implementation enables the client to get the LWT string and notify disconnection \n\nor required message to other clients, as per the requirement. LWT means Last Will and Testament; will \nmeans what is requested on connection death (failure). \n\nMqttConnectOptions options = new MqttConnectOptions(); \n\noptions.setCleanSession(false); \n\n/* Set a will (sought message on a connection death (failure) consisting \nof two bytes on the reconnection after the disconnection. Here SensedData \ndenotes the topic and LWT is sent as the message on that topic. */ \n\n/* SensedData observes the SensedData/LWT message to detect disconnection of \nSensedData client.*/ \n\noptions.setWill(clientDevice.getTopic(\u201cSensedData/ LWT \u201d), \n\n\u201c SensedData Lost\u201d.getBytes(), 2, true); \n\nclientDevice.connect(options); \n\n/* ControlData observes the ControlData/LWT message to detect disconnection \nof ControlData client message.*/ \n\noptions.setWill(clientApp.getTopic(\u201cControlData/ LWT \u201d), \n\n\u201c ControlData Lost\u201d.getBytes(), 2, true); \n\nclientApp.connect(options); \n\n/***********************************************************************/ \n(vi) Declaring threads for publishing the messages on the topic sensed data \n\n\nA client publishes the sensed data. A step is declaring the threads for the topic and messages of each \n\nTOPIC which the client publishes from each streetlight device platform. A string for Topic/Message \nfrom each streetlight in each group of streetlights publishes the light need , working status and traffic \npresence values (Example 1.2 and Figure 9.2). Assume that light need value needs to communicate \nevery 16 m, working status every day and traffic presence each minute. Following is the code for \ndeclaring the TOPIC strings, messages and threads. \n\n/* Set topics and message strings */ \n\npublic static final String TOPIC_LIGHTNEED = \u201cSensedData/deviceID, groupID, \nlightneed\u201d; \n\n/* Assume that LightNeed = true is the message which need to communicate \nevery 16 minutes whenever the ambient light condition demands that streetlight \nshould be switched ON.*/ \n\n/* Create a thread for publishing lightneed every 16 m */ \n\npublic class LightNeed extends Thread { \n\npublishLightNeed(); \n\nfor ( int i=1, i=9600, i++){sleep (1000); } /* Wait 16 m*/ \n\n} \n\npublic static final String TOPIC_WORKINGSTATUS = \u201cSensedData/deviceID, \ngroupID, workingstatus\u201d; \n\n/* Create a thread for publishing working status every day */ \n\npublic class WorkingStatus extends Thread { \n\npublishWorkingStatus (); \n\n374 \nInternet of Things: Architecture and Design Principles \n\nfor ( int i=1, i=24800, i++){sleep (30000); } /* Wait 1 day*/ \n\n} \n\npublic static final String TOPIC_TRAFFICPRESENCE = \u201cSensedData/deviceid, \ngroupid, trafficpresence \u201c; \n\n/* Create a thread for publishing TrafficPresence every 1m */ \n\npublic class TrafficPresence extends Thread { \n\npublishTrafficPresence (); \n\nsleep(30000); sleep(30000); /* Wait 1 m*/ . \n\n} \n\n/*************************************************************************/ \n\n(vii) (a) Publishing the messages by clients at each streetlight on the topic sensed data \n\n/*Next step is publishing of messages by the clients at each streetlight \ndevice platform. Message string publishes for lightneed, workingstatus and \ntraffic-presence from each streetlight in each group of streetlights.*/ \n\nprivate void publishLightNeed() throws MqttException { \n\n/* Declare two numbers for creating a random number*/ \n\nfinal int n1= 100; final int n2=110; \n\nfinal MqttTopic lightneedTopic = client.getTopic(TOPIC_LIGHTNEED); \n\nfinal int lightneedNumber = Utils.createRandomNumberBetween(100, 110); \n\nfinal String lightneed = lightneedNumber + \u201cRequesting ON\u201d; \n\nlightneedTopic.publish(new MqttMessage(lightneed.getBytes())); \n\n} \n\nprivate void publishWorkingStatus() throws MqttException { \n\n/* Write code as above for workingstatus */ \n\n} \n\nprivate void publishTrafficPresence() throws MqttException { \n\n/* Write similar code for trafficpresence */ \n\n} \n\n/*****************************************************************/ \n\n(b) Publishing the messages by application/central controller on the topic \u2018control data\u2019 \n\n/*Next step is publishing of messages by the Application for each \nstreetlight device platform. Message string publishes for control message \nfor each streetlight in each group of streetlights.*/ \n\nprivate void publishControlMessage() throws MqttException { \n\n/* Specify codes for sending controlmessage */ \n\nPrototyping and Designing the Software for IoT Applications \n375 \n\nfinal MqttTopiccontrolmessageTopic = client.getTopic(TOPIC_CONTROLDATA); \n\n\n\n\ncontrolmessageTopic.publish(new \nMqttMessage(controlmessage. \ngetBytes())); \n\n} \n\n/****************************************************************/ \n\n(c) Client application subscription of the messages on the topic sensed data \n\nA coding step is codes for a client subscription, which is reading the values on the topic\u00a0SensedData. \nEach client device sends on the topic SensedData publishes three messages to the broker. \n\u201cSensedData /lightneed\u201d\u00a0, \n\n\u201cSensedData /workingstatus\u201d and \n\n\u201cSensedData/trafficpresence\u201d \n\nA MqttCallback interface has three abstract methods: \n\n1. messageArrived() implementation when runs then the Broker sends the new message to specific \n\nclient device in a group of devices \n2. deliveryComplete() implementation runs when message with specified QoS = 1 or 2 at the \n\nBroker which sends to publisher on successful delivery to subscriber, and \n3. connectionLost() implementation runs when  the connection is unexpectedly closed form the \n\nMQTT broker. \n\n\n(d)  Use a wildcard \u2018#\u2019 instead of subscription to 3 different topics, namely, TOPIC_LIGHTNEED, TOPIC_ \n\nWORKINGSTATUS, TOPIC_TRAFFICPRESENCE, \n\nmqttClient.setCallback(new SubscribeCallback()); \n\nmqttClient.connect(); \nmqttClient.subscribe(\u201cSensedData/#\u201d); \n\nmqttClient.subscribe(\u201cControlData/#\u201d); \n\npublic class SubscribeCallback implements MqttCallback \n{ \n\n@Override \n\n[@Override means as follows: A compile will cause annotation checks of the method for the \noverride. Override method means a method having the same name, same type and same number \nof arguments but has statements which use new arguments and override the earlier statements \nfor that method. When annotated, a compile will cause an error if the method is not found in one \nof the parent classes or implemented interfaces.] \n\npublic void connectionLost(Throwable cause) {} \n\n@Override \n\npublic void messageArrived(MqttTopic SensedData, MqttMessage deviceID, \ngroupID, lightneed) { \n\n/* Write Codes for actions on receiving the lightneed*/ \n\n. \n\n;} \n\n376 \nInternet of Things: Architecture and Design Principles \n\npublic void messageArrived(MqttTopic SensedData, MqttMessage deviceID, \ngroupID, workingstatus) { \n/* Write Codes for actions on receiving the workingstatus */ \n. \n;} \npublic void messageArrived(MqttTopic SensedData, MqttMessage deviceID, \ngroupID, trafficpresence) { \n/* Write Codes for actions on receiving the workingstatus */ \n. \n;} \n@Override \npublic void deliveryComplete(MqttDeliveryToken token) { \n/* Write Codes for actions on delivery completion */ \n. \n; } \n\nClientApplication subscription of the messages on the topic ControlData \n\nmqttClient.setCallback(new SubscribeCallback()); \nmqttClient.connect(); \nmqttClient.subscribe(\u201cControlData/controlmessage\u201d); \npublic void messageArrived(MqttTopic ControlData, MqttMessage deviceID, \ngroupID, controlmessage); \n{ \n/* Write Codes for actions on receiving the wcontrolmessage */ \n. \n;} \n@Override \npublic void deliveryComplete(MqttDeliveryToken token) { \n/* Write Codes for actions on delivery completion */ \n. \n; } \n\nFigure 9.3 shows the connected sensor and actuator which are publishing the sensed \ndata and subscribing for the control data using MQTT Android clients\u2019 communication \nwith application layer MQTT clients through an MQTT broker. \n\nExample 9.12 gives application on Android MQTT client device platform using Paho. \n\nExample 9.12 \n\nProblem \nA programme implementation for  communication with an Android phone using Paho and ADT: \n\nConnected sensor and actuator, which are publishing the sensed data, and subscribing for control messages \nusing MQTT Android clients \n\nPrototyping and Designing the Software for IoT Applications \n377 \n\nImplement codes for Subscriber class for subscribing to the sensed data (for example, electric kettle \ntemperature sensor) by the Android phone. Use Eclipse Moquette Paho implementation of MQTT using TCP? \n\nSolution \n\nAssume that Java JDK version 6 or higher package is used for implementation in Paho. Also Android Software \nDevelopment Kit (SDK) is installed and Android Development Toolkit (ADT) is added as plugin to the Eclipse. \n\nPackage org.eclipse.pahoAndroidApplicationExample; \n\nimport org.eclipses.paho.client.mqttv3.MqttClient; \nimport org.eclipses.paho.client.mqttv3.MqttException; \n\nimport org.eclipses.paho.client.mqttv3.MqttMessage; \n\nCoding is similar to Example 9.11. Following code shows the analogy. \nImplement the Subscriber class for subscribing to the sensed data (for example, electric kettle temperature \nsensor) by the Android phone as follows: \n\n/*Let first step is that within the class Subscriber, declare URL of the MQTT \nBroker and create instance of class MQTTClient. Use MAC Address as Client_ID \nfor publisher ID and the initialization of the MqttClient instance is as per \nfollowing code. Use -subAndroid as a suffix for the Client_Id. */ \n\npublic class Subscriber { \n\npublic static final String MQTT_BROKER_URL = \u201ctcp://broker.mqttdashboard. \ncom:1883\u201d; \n\nDevices using \nMQTT Clients \n\nKettle Electric \n\nTemperature \n\nSensor and \n\nController \n\n1:Published \nSensed data \n10s of Bytes \n\n4:Subscribed \nControl Data \n\n10s of Bytes \n\nIoT or M2M \n\nArea Local \nNetwork and \n\nGateway \n\nNetwork \n\nand \nTransport \n\nMQTT \nBroker \n\n(m2m. \neclipse. \n\norg/ \npaho \n\nAndroid Applications \n\nand Services \nLayer MQTT Clients \n\n2:Subscribed \n\nSensed Data \n\nof Devices \n\n3:Published \nControl Data \n\nfor the \nDevices \n\nAndroid \n\nApp for \n\nIntenet \nControl of \n\nHome \nElectric \n\nKettle \n\nPhysical/Data Link \n\nLayer \n\nAdaptation \n\nLayer \n\nNetwork and \nTransport Layers \n\nLayer \n\nApplication \nSupport/Mobile \nService Provider \n\nLayer \n\nApplication \n\nLayer \n\nFigure 9.3 Connected sensor and actuator, which are publishing the sensed data, and subscribing for \n\ndata control using MQTT Android clients\u2019 communication with the application layer MQTT \nclients through an MQTT broker \n\n378 \nInternet of Things: Architecture and Design Principles \n\n/* client is the instance of MqttClient */ \n\nprivate MqttClient client; \n\npublic Subscriber() \n\n{ \n\nString a1 = \u201c-subAndroid\u201d; \n\n/* Declare clientDevice_ID using method getPhoneNumber( ). */ \n\nString clientDevice_Id = Utils.getPhoneNumber () + a1; \n\ntry { \n\nmqttClient = new MqttClient(MQTT_BROKER_URL, clientDevice_Id); \n\n} \n\ncatch (MqttException e) { \n\n/* Write codes for callback method */ \n\n/* On exeception, Assume that callback method is print the stack trace. */ \n\ne.printStackTrace(); \n\nSystem.exit(1); \n\n} \n\n} \n\n} \n\nEclipse IoT Stack Applications for Projects \n\nThe Eclipse IoT stack includes application layer software (applications and services) for \nOM2M, smart home and SCADA projects. Table 9.3 gives Eclipse implementations and \nframeworks included in the Eclipse IoT stack for application layer software. \n\nTable 9.3 Eclipse implementations and frameworks included in the Eclipse IoT stack for application \n\nlayer software \n\nEclipse Implementation/ \nFramework \n\nDescription \n\nEclipse SmartHome \nA set of implementations for projects for smart homes using wireless and \nwired protocols and network protocols \n\nEclipse SCADA \nA set of SCADA (Supervisory Control and Data Acquisition) functions for \nusages, such as in factory automation, industrial processes buildings and \nhealth systems \n\nEclipse OM2M \nAn open source implementation of SmartM2M and oneM2M standard \nthat enables developing services on a horizontal M2M service platform, \nthe implementation is independently of the underlying network and \nfacilitates the deployment of vertical applications and heterogeneous \ndevices. \n\nPrototyping and Designing the Software for IoT Applications \n379 \n\nReconfirm Your Understanding \n\n\u25cf Needs of developing the software at five levels: (i) Gather + Consolidate, (ii) Connect, (iii) Collect + \nAssemble, (iv) Manage and Analyse, and (v) applications and services in IoT/M2M applications and \nservices. \n\n\u25cf Eclipse open IoT stack is a set of Java frameworks, protocols, development tools and implementations \nincluding usages of OSGi services, such as Clock , Crypto (AES, base64, SHA-1), Geolocatio n, Data and \nCloud Services for the connect and manage functions for IoT solutions. \n\n\u25cf Eclipse IoT stack is for open source technologies for device platforms and running the codes in JVM \nor Eclipse Concierge (a lightweight implementation of OSGi runtime). \n\n\u25cf The stack enables the usages of protocol functions for connectivity and interoperability of device \ngateways. \n\n\u25cf The stack enables the usages of lightweight M2M (OMA M2M standard), MQTT (OASIS IoT standard), \nCoAP (IETF IoT standard) and standard network protocols for IoT gateway services for remote \nmanagement and applications management. \n\n\u25cf Eclipse Pi4J, Eclipse Koneki, Eclipse Mihini, Eclipse Krikkit provide physical cum data-link and \nadaptation layers software. \n\n\u25cf Eclipse Moquette, Eclipse Paho, Eclipse Wakkamma, Eclipse Californium, Eclipse Lehshan, Eclipse \nOM2M, Eclipse Ponte and Eclipse Kura provide gateway, network, transport, application support layer \nsoftware. \n\n\u25cf An example showed the usages of Paho for streetlights IoT where streetlight devices publish the \nsensed data using Paho Java MQTT clients. Applications publish control data and subscribe to the \nsensed data. An Eclipse Paho MQTT broker provides a gateway between the devices and applications. \n\n\u25cf An example showed the usages of Paho for Android MQTT clients for controlling an electric kettle. \n\n\u25cf Application layer implementations for smart home and SCADA projects and for M2M can use Eclipse \nSmartHome, Eclipse SCADA and Eclipse OM2M for software development. \n\nS elf-Assessment E xercise \n\n1. List five levels of software which need to be developed. \n2. Write the features of Eclipse IoT stack. \n3. Which are the Eclipse stacks for implementations using LWM2M and CoAP \n\nclients and LWM2M and CoAP servers in client-server communication \nmodes? \n4. What are the software for functions implemented using Eclipse Pi4J, Eclipse \n\nKoneki, Eclipse Mihini and Eclipse Krikkit? \n5. List the Eclipse stack implementations for devices and interactions with \n\napplication clients through a broker. \n6. When is the LWM2M or CoAP client-server in communication mode? \n7. List the features of Eclipse Kura. \n8. What are for the OSGi service functions used in the implementation of Eclipse \n\nIoT stack? \n9. Write the subscriber and publisher classes for IoT/M2M applications using \n\nthe pub/sub mode of communication. Use the MQTT device clients\u2013broker\u2013 \napplication clients. \n\n\u2605 \n\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\n\u2605\u2605 \n\n\u2605\u2605 \n\u2605\u2605 \n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\n![Image](/src/assets/generated_images/iot2_p406_i0.png)\n380 \nInternet of Things: Architecture and Design Principles \n\n9.4 \nPROTOTYPING ONLINE COMPONENT \nAPIs AND WEB APIs \n\nApplication Programming Interface (API) is a way of \nobtaining input from one face (user-end or a program) and \nsending the request or message or data to another face (an \napplication program). An API initiates the message exchanges. The API initiates action \nwhen it receives inputs, it calls the execution of application codes (set of codes) on input \nevents and initiate running of functions for actions [callback ( )] on them. The API initiates \nand enables desired actions using the computing system, and may also access a service \nwhich is local or remote on occurrence of event of input to the interface. The API can also \ninitiate sessions between the user or client and the applications or service functions. \n\nA web application uses UI and web API. A web API accesses \na service on the web using the Internet and web protocols. A UI \nof a web API gets input from the user or client and accesses a \nservice, such as MSN weather service using MSN weather server. \nFigure 9.4 shows mobile phone weather-application UIs, APIs \nand web API interactions and ten message-exchange sequences. \n\n1:Touch \nEvent \n\n2:Callback  () \nto New \nLocation UI \n\n9: Publish \nCity \nWeather \nData for the \nClients \n\n8: Subscribe \nCity Weather \nData \n\nMobile Phone \n\nWeather \nApplication \n\n3:If  New \nCity-name \nName \nEvent \nAPI for \nLocation \n\nUI and \nGet Input \n\nSession \n\n5:Callback () \nto \nWeather \n\nWeb API \n\nMSN \nWeather \n\nServer \n\n4:Send New City \nName \n\nWeather \n\nUI \n\n10: Send \nService \nMessages for \nCity Weather \nWeb API \n\n6:Callback () Send \nClient Messages \n\nWeather \nWeb API \n\nWiFi \nInterface \n\n7: Session between \nWeather APIs \n\nWeather \n\nService \n\nAPI \n\nIP Network \n\nand UDP \nTransport \nand DTLS \n\nFigure 9.4 The mobile phone weather-application UIs, APIs and web API interactions, and ten message- \n\nexchange sequences \n\n9.4.1 Using the Number of Mashed Up APIs in an Application or Service \n\nA number of APIs can be mashed to get the desired result. Figure 9.4 shows number of \nmashed up APIs in the weather application. \n\nDescribe \nprototyping \nmethods of the online \n\ncomponents for IoT \n\napplication APIs \n\nLO 9.3 \n\nAPI enables \nimplementation of an \napplication or service \n\non the event of input \n\nfrom one end \n\nPrototyping and Designing the Software for IoT Applications \n381 \n\nExample 9.13 clarifies the concept of API, web API and mashing of APIs. \n\nExample 9.13 \n\nProblem \nThe concept of API, web API and mashing of APIs: \n\nHow does a weather-application access the weather-service in a mobile phone? \n\nSolution \n\nThe weather-application in a mobile  phone uses a UI (a screen API) which displays onto screen to seek user \ninput. The phone screen shows up a touch-option with label \u2018weather\u2019. Following are the sequential actions: \n\n\u25cf When user touches \u2018weather\u2019, the touch messages transfer to another UI (User Interface) which appears \non the screen next (sequences 1 and 2 in the Figure 9.4). \n\n\u25cf UI is user interface for location API. It displays a message \u201cWelcome! Please choose your default \nlocation\u201d. The screen also displays a text box with entry \u2018Search for a city\u2019. A cursor points at the \nbeginning of the text box. The user enters the input into the textbox i.e. name of the city using a touch \nkeypad, which also shows up at the bottom (Sequences 3 and 4 in the figure). \n\n\u25cf When the location API gets the name of the city and the user taps at the textbox, the UI display \ndisappears, the phone communicates with the MSN weather site. Weather service gets the messages and \nsends for display onto the \u2018weather\u2019 (Sequences 5 to 10). \n\n\u25cf The \u2018weather\u2019 is a UI for display and hourly refresh. The API displays, \u201cMon, sign for fully Sunny, 30\u00b0, \n18\u00b0; Tue, sign for small part sunny, rest cloudy, 30\u00b0, 19\u00b0, \u2026\u201d, and the city name shows up at the \nbottom line. If the weather UI is touched, then callback function initiates another API. The called API \nUI is full screen, which shows full details of the weather at the selected city. When user touches the UI \nscreen, then the weather messages refresh. \n\nThe weather web application at the phone is using a number of APIs and callback functions. \n\n\u25cf The screen UI gets input (touch) from the user. The UI sends in output weather tile touch message to \nthe location API. \n\n\u25cf The location API for weather gets input for the name of the city. When input is given then it callbacks \na back-end code for weather access. The code accesses to the MSN weather site using the Internet over \nWiFi network to which the phone is connected. The location API sends the city name. \n\n\u25cf Weather web-API callback functions interact with weather-API service for weather service messages. It \nsubscribes to the MSN weather server. The server publishes weather messages for the subscribing clients \n(Sequences 5 to 7). \n\n\u25cf Weather service API sends service messages as a response which communicate over the Internet to \nthe weather client of weather web API. The service also sends in response presence and next two days \npredications, and expected maximum and minimum temperatures (Sequence 8 to 10). \n\nEarlier Example 9.13 used mobile phones as the device platform. Refer to Example 1.1 \nof IoT. The example considered a smart umbrella as a device platform, which enables the \numbrella, and behaves like living entity through computing. An embedded small device \ninteracts with the weather web-service and mobile of the owner through the Internet. \nFigure 9.5 shows weather web-API for an umbrella, extreme weather-message web-API, \nmobile phone web-API, and weather-service API, and their interactions, and fourteen \nsequences of message exchanges. \n\n382 \nInternet of Things: Architecture and Design Principles \n\n9:Published \nCity \nWeather \nData for the \nClients \n\n8:Subscribe \nWeather \nData of City \n\nSmart and \nAlive Umbrella \nApplication \n\n2: Request for \nPlace and City- \n\nName \n\n6:Callback  () \nTo  Weather \n\nService Web \nAPI \n\nMSN \nWeather \nServer \n1:Each \nDay Event \nmessage \n\nIP Network, \nUDP \nTransport \nand DTLS \n\nUmbrella ID, date \nand time, and \nlocation stamps \n\n5:Callback () Send \nClient Messages \n\nWeather \nweb API \n\nWiFi \nInterface \n\n7: Session between \nWeather APIs \n\nWeather \nService \nAPI \n\nLocation \nService \nAPI \n3: Response  for \nPlace and City-name \n\n4:Callback  () \non  New \nLocation \nEvent \n\n10: Send \nService \nMessages for \nCity Weather \n\nWeb API \n\nAPI for \nLocation \nand Get \ninput \nSession \nMobile API \nfor Text \nMessaging \n11: Umbrella \nExtreme \nWeather \nEvent \n\n13: Send Data for Warning Messaging \nService in Case of Extreme Weather \n\nUmbrella \nMobile \nAPI \n\nNFC \nInterface \n\n12: Warning Messages by LED Flashes \n\n14: Receive Warning \n\nMessage Text from \nSmart and  Alive \nUmbrella \n\nFigure 9.5 Umbrella weather web API, location API, extreme weather warning message umbrella \n\nmobile API, mobile phone text messaging API, weather service API and their interactions \nand fourteen sequences of message exchanges \n\nExample 9.14 clarifies the concept of APIs and web APIs for Internet of Smart and Alive \numbrella. \n\nExample 9.14 \n\nProblem \nThe concept of APIs and web-APIs for Internet of Smart and Alive Umbrella: \n\nHow does a \u2018Weather\u2019 API at an umbrella access a weather service and communicate an expected  extreme \nweather event, such as rain or hot sunny day to a mobile phone API by a text message? \n\nSolution \n\nAssume that an umbrella consists of an embedded device for an IoT weather application. The device \napplication uses a mash of APIs as follows: \n\n\u25cf When a start of the day event, say 8 a.m., ticks at the clock (Sequence 1 in Figure 9.5), a callback() \nfunction executes and sends a client-request to the location server (Sequence 2), and pulls the location \ndata (sequence 3). Sequences 2 and 3 find the location and generate event message on location change. \n\n\u25cf Location API sends message for new location in case of device-location change (Sequence 4). \n\n\u25cf The messages communicate in JSON Object format (Section 3.2.3). The umbrella ID, date, time and \nlocation stamps communicate on the day-start event to the weather API. Sequences 5 to 10 are similar \nto that in Example 9.13 for mobile phone web APIs. \n\n\u25cf An event, if generates an extreme weather warning, then a callback function executes. The warning can \nbe by LED flashes at the device or by a text message on the mobile. \n\nPrototyping and Designing the Software for IoT Applications \n383 \n\nThe weather web application at the umbrella is using number of APIs and callback functions. These are: \n\n\u25cf Location API gets the name of the city from the location server. (Sequences 2 and 3). \n\n\u25cf The weather web-API callback functions interact with the weather API for the weather service messages. \nThe API subscribes to MSN or another weather Server. The server publishes weather messages for the \nsubscribing clients (Sequence 5 to 8). \n\n\u25cf Weather service API sends service messages as a response which communicates over the Internet to \nthe weather-client of the web API. The weather service also communicates in response the present and \nnext two days predications, and expected maximum and minimum temperatures (Sequences 9 and 10). \n\n\u25cf Umbrella mobile web API sends message for owner on mobile using NFC protocol (Sequences 11 and \n13 in the figure). \n\nImplementing the APIs in an Application or Service \n\nAn application or service consists of mashed APIs. Following are the steps for implementing \nthe APIs: \n\n1. Make an implementation table for sequences of API actions. A session of message \n\nexchanges between two ends of API may consist of number of actions. \n\n\u25cf Column 1 of each row has the actions in sequences which occur one by one. \n\n\u25cf Column 2 may specify for each action, the authentication code or method (device \nplatform ID, such as MAC address) for secured communication to and from other \nend (server or application). Column 2 has authentication method for use that may \ninvolve user/password communication. User in case of IoT device platform is \ndevice platform ID, such as MAC address. Password can be some code internally \ngenerated at device platform using some algorithm using a secret key as input \n(Example 9.8). \n\n\u25cf Column 3 specifies the API inputs for initiating the action on event. \n\n\u25cf Column 4 specifies the API outputs for the inputs. The outputs communicate \nto other end and initiate the execution of methods, callback functions, generate \nrequests or send responses. \n2. Use the secure communication protocols, such as DTLS/TLS. \n3. Use the standard formats for object or message exchanges: JSON, TLV or XML or \n\nREST style of URIs or URLs for message format (Section 3.2). \n4. Use for access to remote methods standard protocols, such as SOAP (for XML-RPC) \n\nor JSON-RPC. RPC stands for remote procedure call. Procedure also means function \nin C/C++ or method in Java (Sections 3.3 and 3.4). \n5. Use the standard client-server protocols, such as MQTT when using publish/subscribe \n\nor such as XMPP models of message or object exchanges (Section 3.2). \n6. Use the standard client and server protocol for client-server http, or CoAP or ws \n\nprotocol using client-response model of message or object exchanges (ws:// used in \nplace of http:// for bi-directional message exchanges) (Section 3.4). \n7. Use the standard methods for web object or message exchanges. For example, REST \n\nrequest-response model methods, such as HTTP GET/POST methods or WebSocket \nmethods for bi-direction message exchanges (Section 3.4). \n\n384 \nInternet of Things: Architecture and Design Principles \n\n8. Use the scripts, for example, JavaScript or Node.js framework for creating set \n\nof codes in event model or codes for running at distributed computing systems \n(device platforms or services at web/cloud). Event model calls a callback() \n[onEventAction()] functions on inputs. The function may initiate sending a client \ndata or sending a server response. Function runs once on each input-event. \n9. Use the language or scripting language framework which provides wider support of \n\nlibraries, community and test tools. \nExample 9.15 explains the table for easy implementation of API. \n\nExample 9.15 \n\nProblem \nDrawing an implementation table for weather web APIs: \n\nHow does a table make it easy writing codes for weather web APIs? Use the sequences shown in \nFigure 9.4. \n\nSolution \n\nTable 9.4 gives the actions, inputs and outputs for weather APIs. \n\nTable 9.4 \nImplementation table for weather web APIs \n\nSequence Number \nand Action \n\nAuthentication \nInputs \nOutputs \n\n1: New connection \nto weather service \nAPI \n\nMAC address \nor deviceID/ \nApplicationID/ \nAPI_ID \n\nLocation (City Name) \nMessage to weather web client \nto enable client connect to send \nrequest for weather messages \n\n2: New connection \nto weather Service \n\nMAC address or \nweather service \nAPI ID \n\nMessages (city name, \nClientID, time stamp) \n\nSubscribe to the weather service, \nif a new city name (messaged from \nthe location server) \n\n3: New connection \nto weather service \n\nMAC address or \nweather service \nAPI ID \n\nMessages of weather \nweb-service API on new \ncity name \n\nSubscription message(s) on new \ncity to the weather service and \nmessages \n(clientID, \nweather \ninformation with with time stamp \nfrom messaged data) \n\n3: New response of \nweather service \n\nMAC address or \nweather service ID \n\nWeather messages and \nwarnings for this and \npredictions of next two \ndays for the city from \nrepository \n\nResponse message(s) \n\nPrototyping and Designing the Software for IoT Applications \n385 \n\n9.4.2 APIs Implementation Using REST Methods \n\nWhen implementing a REST API or using REST methods in client or server, first making \na table makes the coding easy. \n\n\u25cf Column 1 of each row has the URL for communication for implementing an action. \n\n\u25cf Column 2 may specify the action (REST methods), such as PUT/GET/POST/DELETE \nfor implementation. \n\n\u25cf Column 3 may specify for each action, the authentication code or method (device \nplatform ID, such as MAC address) for secured communication to and from other \nend (server or Application). Column 3 has authentication method for use at server/ \ndestination end that may involve user/password session. User in case of IoT device \nplatform is device platform ID, such as MAC address. Password can be some code \ninternally generated at device platform using some algorithm using a secret key as \ninput (Example 9.8). \n\n\u25cf Column 4 specifies the API inputs/parameters for initiating the action. \n\n\u25cf Column 5 specifies the API outputs for the inputs. The outputs communicate to other \nend and initiate the execution of methods, callback functions, generate Cookie or \nresponse. \n\n9.4.3 API Implementation in WebSockets \n\nWebSocket enables bi-directional communication at the same instances between two ends. \nThe WebSocket needs lesser header-size when compared to the HTTP header size (Figure \n3.9)  HTTP client first pulls data from one end to another and later other end-clients in \nother direction (Section 3.4.5). \n\nEclipse Jetty is a WebSocket implementation in Java and is open source from a weblink \nhttps://www.eclipse.org/websocket. The implementation uses Jetty WebSocket (String). \nMaximum message size declares as WebSocket (maxTextMessageSize). WebSocket Client \nand server both use the callback listeners onOpen, onMessage, OnClose, onError. A Java \nimplementation imports following: \n\nimport org.eclipse.jetty.websocket.client.WebSocketClient; \nimport org.eclipse.jetty.websocket.api.Session; \nimport org.eclipse.jetty.websocket.api.StatusCode; \nimport org.eclipse.jetty.websocket.api.annotations.OnWebSocketOpen; \nimport org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect; \nimport org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage; \nimport org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose; \nimport org.eclipse.jetty.websocket.api.annotations.OnWebSocketOnError; \nPackages, classes, methods, variables and parameters may be annotated in Java. \nAn annotation in Java is a form of syntactic metadata that can be added to a Java source \n\n386 \nInternet of Things: Architecture and Design Principles \n\ncode. Syntactic metadata refers to the format instructions for storage of the values or class \nor method. \n\nFollowing are the callback WebSocket methods: \n\n\u25cf onWebSocketConnect() \n\n\u25cf onWebSocketMessage() \n\n\u25cf onWebSocketClose() \nOpen source Paho Go Client at Eclipse Paho consists of added WebSocket (ws) clients to \nconnect to an MQTT broker. Open source Eclipse Ponte consists of added MQTT-over-ws \nclients in JavaScript. \n\nOpen source client-server WebSocket methods for implementation on Arduino device \nplatform can be used from the weblink https://github.com/krohling/ArduinoWebsocket \nand https://github.com/djsb/arduino-websocket. Krohling Arduino ws client and ws \nserver (bi-directional) implementation is as follows: \n\n\u25cf Declare MAC address as follows: byte mac48BitAddress (six bytes separated by \ncomma) \n\n\u25cf Declare WebSocket server URL as follows: char server [] = \u201cecho.websocket.org\u201d for \ninitialization \n\n\u25cf Declare serverSocket (8080) for using HTTP alternate web server for initial creation \nof WebSockets using echo. Echo means sending the message and receiving same \nmessage back when WebSockets successfully create.http web server port is 80. When \na secondary or alternate web server hosted the port number 8080 is used. 8080 is \ncommonly used for proxy and caching \n\n\u25cf Declare object wsClient of class WebSocketClient \n\n\u25cf Declare wsClientDA object of class dataArrivedWebSocketClient for web object of \narrived data \n\n\u25cf Declare callback method dataArrived (WebSocketClient wsClientDA, String message) \non an end receiving string from WebSocket \nThe HTTP client sends the request or messages to the HTTP server and waits for a \nresponse. The server sends response or messages. A WebSocket client is that which initiates \nthe connection to peer. A WebSocket server is published and waits for the connections \nfrom the peers. \n\nFigure 9.6 shows the sequences of sessions for message exchanges when using \nWebSocket objects. \n\nFollowing are methods wsclient.available(), wsclient.connect(Server), wsClient. \nconnection(), wsClient.connected(), wsClient.send(), wsClient.setDataArrived() and \nwsClient.setDataArrivedDelegate(String dataArrived) for communication after creating \nWebSocket clients for bi-directional exchange of messages. \n\nWhen implementing a WebSocket API or ws client or ws server, first making a table \nmakes the coding easy. Following are the columns: \n\nPrototyping and Designing the Software for IoT Applications \n387 \n\nEcho Session \n1: EchoSocket sends a String \n2: EchoSocket receives back echo \nHTTP Client \nHTTP Secondary \nweb Server \n\nIf @onWebSocketConnect returns true then callback Sessions 3, 4, .... between \nwebSocket APIs till @onWebSocketClose returns true \n\nClient new \nfunctioning: \nWebSocket \nClient object \n\nServer new \nfunctioning: \nWebSocketClient \nobject \n\n3: Session for webSocketClient bi- \ndirectional send and receive messages \n4: Session webSocketServer bi-directional \nsending and receiving the messages \nSessions \n\nMethod for bi-directional sessions 3 and 4: \nsession.getRemote (). sendStringwebObject (String) \n\nEcho \nSession \n\nFigure 9.6 \nSequences of sessions for message exchanges when using WebSockets \n\n1. Column 1 of each row has the URI or URL of message destination end for \n\ncommunication for implementing an action. \n2. Column 2 may specify the action such as following callback WebSocket \n\nmethod: \nonWebSocketOpen, \nOnWebSocketSession, \nonWebSocketConnect, \nonWebSocketMessage String Message, Session session), onWebSocketClose or \nfollowing method WebSocket (maxTextMessageSize) when using Eclipse Jetty \nWebSocket implementations. \n3. Column 3 may specify for each action, the authentication code or method (device \n\nplatform ID, such as MAC address) for secured communication from source end to \ndestination end. Column 3 has authentication method for use at the destination-end \n(server or application/service) that may involve user/password communication. User \nin case of IoT device platform is device platform ID, such as MAC address. Password \ncan be some code internally generated at device platform using some algorithm \nusing a secret key as input (Example 9.8). \n4. Column 4 specifies the API inputs/parameters for initiating the action. \n5. Column 5 specifies the API outputs for the inputs. The outputs communicate to other \n\nend and initiate the execution of methods, callback functions, generate cookie or \nresponse. \nExample 9.16 explains a WebSocket APIs implementation table method. \n\nExample 9.16 \n\nProblem \nImplementation table for the weather and weather service APIs using Eclipse webSocketClient library: \n\nHow is implementation table drawn for ease of writing codes for weather and weather service APIs? Use the \nlibrary at Eclipse website. 22 \n\n22 http:// jetty.websocket.client.WebSocketClient.eclipse.org \n\n388 \nInternet of Things: Architecture and Design Principles \n\nSolution \n\nTable 9.5 gives the actions, inputs and outputs for weather and weather service APIs. \n\nTable 9.5 \nImplementation table drawn for ease of writing codes for a weather and weather service APIs \n\nSequence \nnumber and \nURL \n\nMethod \nAuthentication \nInputs \nOutputs \n\n1: URL of \nweather \nservice API \n\nonWebSocketConnect() \nMAC address \nor deviceID/ \nApplicationID/ \nAPI_ID \n\n\u2014 \nCreation of \nWebSockets \n\n2: URL \nweather \nservice \n\nonWebSocketMessage() \nMAC address or \nweather service \nAPI ID \n\ncallback(), \nMessages (city \nname, ClientID, \ntime stamp) \n\nRequest to weather \nservice \n\n3: URL of \nweather \nservice API \n\nonWebSocketMessage() \nMAC address or \nweather service \nID \n\ncallback(), \nMessages of \nweather web- \nservice \n\nResponse of service \nfor messages \n(clientID, weather \ninformation with time \nstamp) \n\n4: URL of \nweather Web \nAPI \n\nonWebSocketMessage() \nMAC address or \nweather service \nAPI ID \n\nWeather messages \nand warnings for this \nand predictions of \nnext two days for the \ncity \n\nReconfirm Your Understanding \n\n\u25cf An API is a way of obtaining input from one face and sending the request/message/data to another \nface (other set of codes). The API enables initiations of events, obtaining inputs, execution of \napplication codes (set of codes) on input events and running the functions (callback functions) on \ninput event. Web API is an API which uses web protocols for web applications. \n\n\u25cf Example of weather application in a mobile phone and the smart and alive umbrella shows the uses \nof APIs and web APIs. \n\n\u25cf Example of smart and alive umbrella shows the uses of APIs and web APIs. \n\n\u25cf APIs implementation using standard message or object formats, protocols and models. \n\n\u25cf APIs implementation using standard message format, protocols, language or script framework with \nwider library, community and test tools. \n\n\u25cf API implementation is easy when a table is made for each action of the sessions and interactions, \nspecifying the authentication methods, inputs and outputs. \n\nPrototyping and Designing the Software for IoT Applications \n389 \n\n\u25cf Message exchanges between APIs, webAPIs, webService APIs, webClient and webServer use REST \nAPIs and WebSockets. \n\n\u25cf Eclipse Jetty, Paho and Ponte implementation provide the library functions for WebSockets and \nWebSocket APIs. \n\nS elf-Assessment E xercise \n\n1. Define the functions of API. \n2. Why are APIs used for communicating with application/service at both server \n\nand client ends? \n3. Draw a diagram showing sessions between location API and location service \n\nAPI. \n4. Draw a table of actions and sessions for implementing the APIs in example of \n\nInternet of Smart and Alive Umbrella. \n\n\u2605 \n\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605\u2605 \n\nKey Concepts \n\n\u25cf Application \n\n\u25cf Application programming \ninterface \n\n\u25cf Authentication \n\n\u25cf Callback functions \n\n\u25cf Client \n\n\u25cf CoAP \n\n\u25cf Crypto functions \n\n\u25cf Development framework \n\n\u25cf Distribution \n\n\u25cf Eclipse IoT stack \n\n\u25cf Embedded devices \n\n\u25cf Encryption \n\n\u25cf Event model \n\n\u25cf Gateway methods \n\n\u25cf Hash algorithm \n\n\u25cf Integrated development \nenvironment \n\n\u25cf IoT stack \n\n\u25cf Kura \n\n\u25cf Library functions \n\n\u25cf LWM2M \n\n\u25cf MAC address \n\n\u25cf Mashed up APIs \n\n\u25cf MQTT broker \n\n\u25cf MQTT client \n\n\u25cf OM2M \n\n\u25cf OSGi services \n\n\u25cf Paho \n\n\u25cf Ponte \n\n\u25cf REST methods \n\n\u25cf Server \n\n\u25cf Software serial library \n\n\u25cf Service \n\n\u25cf Test functions \n\n\u25cf WebSockets \n\nLearning Outcomes \n\nLO 9.1 \n\n\u25cf A number of device platforms of IDEs, such as Arduino, Intel Galileo, RPi, BB and mBed, \nprovide development tools, libraries and framework, and are used for the development of \nembedded Software. \n\n390 \nInternet of Things: Architecture and Design Principles \n\n\u25cf A number of programming examples explain the process of developing the codes and test \ncodes. \n\n\u25cf Arduino IDE is simpler and embedded software requires building upon just two functions: \nsetup() and loop(). Bootloader enables simple multitasking by the usages of interrupt handlers. \n\n\u25cf A serial monitor at the IDE enables computer obtaining results from the serial port of device \nplatform for display on monitor. \n\n\u25cf Number of library functions provides the ease in programming. For example, usage of timer \nand software serial libraries. \n\n\u25cf Examples explained the usages of: (i) timer functions, (ii) reading of RFID tag using UART \nfunctions and (iii) I2C communication between sensor communicating sensed data using I2C \nand device I2C port. \n\n\u25cf An example showed how the multiple threads of a program execute on a device platform. \n\n\u25cf Things communicate to the Internet using functions for Ethernet, WiFi and IP. \n\n\u25cf Things communicate data securely using cryptolibrary functions, such as AES128, AES192, \nAES256 or DES. \n\nLO 9.2 \n\n\u25cf Eclipse IoT stack implementations enable the software components, development device, \ngateway, Internet and web/cloud application service. \n\n\u25cf The development of software components takes place at five levels: (i) Gather + Consolidate, \n(ii) Connect, (iii) Collect + Assemble, (iv) Manage and Analyse, and (v) Applications and \nServices in IoT/M2M applications and services using Eclipse open IoT stack. \n\n\u25cf Eclipse IoT stack of the device platforms is for open source technologies, usages of protocol \nfunctions, connectivity and interoperability of the device gateway, lightweight M2M (OMA \nM2M standard), MQTT (OASIS IoT standard), CoAP (IETF IoT standard), IoT gateway services, \nremote management and applications management. \n\n\u25cf Eclipse IoT stack implementations use the Eclipse Pi4J, Eclipse Koneki, Eclipse Mihini, Eclipse \nKrikkit, Eclipse Moquette, Eclipse Paho, Eclipse Wakkamma, Eclipse Californium, Eclipse \nLehshan, Eclipse OM2M, Eclipse Ponte and Eclipse Kura provide gateway, network, transport, \napplication-support layers\u2019 software components. \n\n\u25cf A number of Java programming examples explain the process of usage of Paho MQTT clients \npublishing the messages and subscribing for the messages through an MQTT Broker. Eclipse \nPaho MQTT broker provides a gateway between the devices and applications. \n\n\u25cf Paho enables usage of Android MQTT clients for controlling the devices through the Android \nphone clients. \n\n\u25cf Eclipse stack IoT and M2M solution frameworks for application layer implementations enable \napplications software components development for smart home, SCADA and OM2M projects. \n\nLO 9.3 \n\n\u25cf APIs and web APIs enable message exchanges between embedded devices and applications/ \nservices at the server/cloud. \n\n\u25cf API obtains input from one face and sends the request or message or data to another face (other \nset of codes). The API enables initiations, obtaining inputs, execution of application codes (set \nof codes) on input events and running functions (callback functions) on input event. Web API \nis an API which uses web protocols. \n\n\u25cf A number of examples explained the implementations using standard message or object \nformats, protocols and models. \n\nPrototyping and Designing the Software for IoT Applications \n391 \n\n\u25cf Way of message exchanges between APIs, webAPIs, webService APIs, web client and web \nserver explained with usages of the REST APIs and WebSockets. \n\n\u25cf Eclipse Jetty, Paho and Ponte implementation provide the library functions for WebSockets and \nWebSocket APIs. \n\nExercises \n\nObjective Questions \n\nSelect one correct option out of the four in each question. \n\n1. The levels for developing the software are: (i) Gather + Consolidate, (ii) Connect, (iii) \n\nCompacting, (iv) Manage and Analyse, and (v) Querying databases of devices data \nby the applications and services in IoT/M2M applications and services. \n(a) (i) to (v) except (iii) \n(b) (i) to (v) \n\n(c) (i) to (iv) \n(d) All except (iii) and (v) \n2. The Arduino IDE includes: (i) C/C++ library, (ii) Java Library, (iii) JavaScript, \n\n(iv) Wiring library, (v) Processing language, (vi) setup() and loop() functions, \n(vii) Arduino device platform has bootloader embedded into that and usages of the \nOS is not a must and may add OS Linux distributions. \n(a) All except (ii) and (iii) \n(b) (i) to (vii) \n\n(c) (i) to (vi) \n(d) (i) to (v) except (iii) \n3. Which of the following statement is correct? (i) Pins, Tx or TxD (for serial transmission \n\nof header, data and other bits) and Rx or RxD (for serial reception of data) are used \nfor I2C bus communication, (ii) Pins SDA and SCL are used for the UART bus \ncommunication, (iii) RFID tag communicates to the reader using UART, (iv) UART \nBAUD rate is always 9600, (v) I2C bus is asynchronous bus, (vi) Two Arduino boards \ncan communicate with each other using I2C. \n(a) All except (ii) and (iii) \n(b) (i) to (vi) \n\n(c) (iii) and (vi) \n(d) (i) to (v) except (iii) \n4. AdafruitIDE is for Raspberry Pi and can be updated for BeagleBone, (ii) RPi connects \n\nto LAN when coding, (iii) Coding can be using Python, JavaScript or Ruby languages, \n(iv) Adafruit also OS for functions of keyboard and display monitor, (v) Includes \na secure shall (SSH) for cryptographic network protocol for the Application layer, \n(vi) enables remote login, and (vii) remote connections of the systems, keyboard and \nmonitor. \n(a) All except (ii) and (iii) \n(b) (i) to (vii) \n\n\u2605 \n\n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605 \n\n392 \nInternet of Things: Architecture and Design Principles \n\n(c) All except (v) \n(d) (i) to (vi) \n5. IoT security risks are: (i) an in-between switch or router or server S reads messages \n\nbetween two ends and replays the same for authentication at a communicating end \nfor obtaining access to communication between two ends, (ii) S modifies the data of \none end and other end can wrongly authenticate the application or get the modified \ntext, (iii) Two requirements for IoD data secure communication are authentication \nand encryption of data. AES128, AES192, AES256 or DES functions are used for \n(iv) encryption and (v) authentication. \n(a) (ii) to (iv) \n(b) (i) to (iii) \n\n(c) (i) to (iv) \n(d) All except (v) \n6. The features of Eclipse IoT stack components and frameworks for the IoT solutions \n\nare: (i) Provides open source and specifications, (ii) Specifications as per OSGi, \n(iii) Simpler open source implementations and program development using the open \nsource Java frameworks and services, (iv) C implementation in Paho and Californium, \n(v) Python and Java Script implementations. The stack enables usages of (v) LWM2M \nand MQTT, (vii) CoAP, (viii) TCP, (ix) UDP, (x) DTLS, and (xi) IoT gateway services \nfor remote management and applications management. \n(a) (ii) to (xi) \n(b) (i) to (viii) \n\n(c) All except (iv) and (v) \n(d) All except (xi) \n7. An application programming interface: (i) obtains from one end and sending the \n\nrequest or message or data to another end API, or (ii) application or service end or \n(iii) database server end, (iv) Broker end, (v) web server end, (vi) The API enables \ninitiations on obtaining inputs, call for execution of application codes (set of codes) \non input events and initiate running the functions (callback functions) on input event. \n(a) All \n(b) All except (ii) to (iv) \n\n(c) All except (ii) and (iv) \n(d) All except (iv) \n8. The API (i) initiates and (ii) enables desired actions using the computing system, \n\n(iii) may also access a service which is local, or (iv) remote on the event of input to the \ninterface. The API can have (v) initiate sessions between user or client, and (vi) the \napplication functions, or (vii) service functions. \n(a) (ii) to (vi) \n(b) (i) to (viii) \n\n(c) All except (iv) \n(d) (i) to (v) \n9. Which of the following statement is correct? (i) HTTP enables one-direction \n\ncommunication at an instance, client end to server end or server end to client end, \n(ii) HTTPS enables secure communication at an instance, (iii) WebSocket connection \ncan create first by using an HTTP session, (iv) WebSockets are used for chat room \n\n\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605 \n\n\u2605\u2605\u2605 \n\nPrototyping and Designing the Software for IoT Applications \n393 \n\nAPIs, (v) WebSocket communicate larger header than http, and (vi) WebSockets are \nreal time communication only and cannot be used for pulling responses on requests. \n(a) (i) to (vi) \n(b) (i) to (iv) \n\n(c) All except (iv) and (v) \n(d) All except (iii) \n10. Which of the following statement is correct? (i) REST methods are PUT/GET/POST/ \n\nDELETE implementation in API using REST style communication architecture, (ii) \nREST APIs use the URL for access to a resource, (iii) Callback(), (iv) object method() (v) \nC functions WebSocket methods are onWebSocketConnect(), onWebSocketMessage(), \nand onWebSocketClose(). \n(a) (i) to (iv) \n(b) (i), (ii), (iv) and (v) \n\n(c) (i) to (iii) \n(d) All except (iv) and (v) \n\nShort-Answer Questions \n\n1. What are the five levels in software development for IoT applications and services? \n\n[LO 9.1] \n2. Why is it necessary to write the test functions? Why are debugger and emulators \n\nused? \n[LO 9.1] \n3. List and write usages of library functions for sensing the ADC readings given in the \n\nautomobile embedded devices  Example 9.3. \n[LO 9.1] \n4. What are the UART port library functions needed for communicating the IDs of \n\nRFIDs ? \n[LO 9.1] \n5. When is UART and I2C communication used? \n[LO 9.1] \n6. What are the IDEs for Raspberry Pi? \n[LO 9.1] \n7. What are the security risks taken care of when: (i) using a secret key and its secure \n\ncommunication, (ii) using encryption and decryption functions, such as, AES128, \nAES192, AES256 or DES? \n[LO 9.1] \n8. List the Ethernet and Wi-Fi functions for IoT systems. \n[LO 9.1] \n9. When do you use CoAP, MQTT and HTTP client? \n[LO 9.2] \n10. Why are the device_ID, deviceGroupID and Application_ID needed, and time \n\nstamped data-communication needed for sending data to an application or service? \n\n[LO 9.2] \n11. When do you use MQTT clients and MQTT broker, and CoAP clients and servers for \n\ncommunicating the devices data? \n[LO 9.2] \n12. What are the benefits obtained on using the Eclipse sandbox servers? \n[LO 9.2] \n13. What are the differences in usages of Eclipse Paho and Ponte for IoT gateway message- \n\nexchanges between device clients and the application or service? \n[LO 9.2] \n14. Why is MAC address usable for authenticating a device platform at the application/ \n\nservice APIs? \n[LO 9.3] \n15. List the steps for message-exchanges using APIs. \n[LO 9.3] \n16. Explain usages of HTTP client, HTTP server, HTTP secondary server, HTTPS client- \n\nserver, WebSocket Client and WebSocket server. \n[LO 9.3] \n\n\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\n\u2605 \n\u2605\u2605\u2605 \n\n\u2605\u2605 \n\n\u2605 \n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605 \n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\u2605\u2605\u2605 \n\n394 \nInternet of Things: Architecture and Design Principles \n\nReview Questions \n\n1. What are the features of Arduino IDE that enable the programming tasks simpler at \n\nArduino platform? \n[LO 9.1] \n2. How are the pins programmed for digital IO and UART serial IOs at Arduino \n\nplatform? \n[LO 9.1] \n3. What are the features of IDE for Intel Galileo devices in addition to compatibility \n\nwith Arduino? \n[LO9.1] \n4. Describe the IDEs for Raspberry Pi and BeagleBone? \n[LO 9.1] \n5. What are different software components of Eclipse IoT stack for developing software \n\nfor embedded devices? \n[LO9.2] \n6. What are the different software components of Eclipse IoT stack for developing \n\nconnectivity software? Explain the uses and functions of LWM2M, CoAP and MQTT \nprotocols with diagrams. \n[LO9.2] \n7. What do you mean by IoT gateway services for remote applications management? \n\nWhat are the functions of Eclipse Kura? \n[LO9.2] \n8. What are the different software frameworks of Eclipse IoT stack for developing IoT \n\nsolutions? \n[LO9.2] \n9. Why are APIs used? Describe the ways of implementing APIs for device platform \n\nclients and a server for application/service ends. \n[LO 9.3] \n10. When are the REST APIs used? When are WebSockets between the device platform \n\nand web APIs used? Describe differences in APIs for REST and WebSocket functions. \n\n[LO 9.3] \n\nPractice Exercises \n\n1. An embedded device platform is Arduino Uno.  Write a program to drive a moving \n\ndisplay of 24 LEDs, which are arranged in the shape of a garland. How will the four \noutputs at port pins be multiplexed and programmed? \n[LO9.1] \n2. Sensor data readings are the input to an ADC. The ADC coverts the analog input of \n\nsensor to 10-bits output. The output converts to a serial input using a parallel to serial \nconverter. The serial input is read by the Uno serial port, which receives data input \nat 0.8333 ms intervals. Write a program for reading of sensor data at a serial input in \nArduino Uno. \n[LO9.1] \n3. List the functions needed in a timer library. Show how will you use the library to call \n\na callback function after successive intervals of 2 s each. \n[LO9.1] \n4. An Arduino board has SDA bits at pin A4 and SCL bits at pin A5. How will the \n\nsoftware serial library enable the serial readings from 8 temperature sensor circuits \non an I2C bus? Each sensor has addresses starting from 0x10 to 0x17. \n[LO9.1] . \n5. Write the sequences of bits and bytes when using an UART interface, when it \n\ncommunicates an ID of an RFID consisting of 10-characters. \n[LO 9.1] \n6. List the steps for secure communication of an RFID tags ID. \n[LO 9.1] \n7. Write a program for running four threads at successive intervals of 16.666 ms. Use the \n\nmultithreading functions  of an OS. \n[LO9.1] \n8. Draw a diagram showing how the connected streetlights send the sensed data. \n\nThe clients at streetlights device platform are using CoAP protocol when they \ncommunicate with a CoAP server. The server sends data to applications at a central \n\n\u2605 \n\n\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605\u2605 \n\n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605\u2605 \n\n\u2605 \n\n\u2605\u2605 \n\u2605\u2605 \n\n\u2605\u2605\u2605 \n\nPrototyping and Designing the Software for IoT Applications \n395 \n\ncontroller. Californium is a Java implementation of CoAP including DTLS. How can \nEclipse Californium be used for IoT security using DTLS? \n[LO9.2] \n9. Draw a diagram showing the sequence and functions for the devices data in \n\nautomobiles. The data communicates using the Internet to a central automotive \nservice (Example 5.2). Use Eclipse IoT stack implementations. \n[LO 9.2] \n10. Draw a functional diagram for streetlights using APIs for IoT sensors data and \n\nControl_ Application. Show the interactions between the two sets of APIs. Also show \nthe sequences of message-exchanges. \n[LO 9.3] \n11. How is a query sent and responded by an API at a database server? \n[LO9.3] \n12. How is data of a group of sensors aggregated at a gateway and communicated using \n\nan HTTP client and HTTP server? The data is to be added with time stamps, groupIDs \nand sensorIDs. \n[LO9.3] \n\n\u2605 \n\n\u2605\u2605 \n\n\u2605 \n\u2605\u2605\u2605 \n\n",
  "createdAt": "2026-02-17"
}